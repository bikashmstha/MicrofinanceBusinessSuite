/*
 * File: app/controller/DeRegistration.js
 *
 * This file was generated by Sencha Architect version 2.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.DeRegistration', {
    extend: 'Ext.app.Controller',

    stores: [
        'AccountType'
    ],

    onPanDeReg_txtPanKeypress: function(textfield, e, options) {


        if(e.keyCode === 13 || e.keyCode === 9)
        {

            var me=this;

            var Pan=Ext.ComponentQuery.query("#PanDeReg_txtPan")[0];
            var Name=Ext.ComponentQuery.query("#PanDeReg_txtName")[0];
            var Phone=Ext.ComponentQuery.query("#PanDeReg_txtPhone")[0];
            var HouseNo=Ext.ComponentQuery.query("#PanDeReg_txtHouseNo")[0];
            var WardNo=Ext.ComponentQuery.query("#PanDeReg_txtWardNo")[0];
            var AreaName=Ext.ComponentQuery.query("#PanDeReg_txtAreaName")[0];
            var VDCName=Ext.ComponentQuery.query("#PanDeReg_txtVDCName")[0];
            var DistrictName=Ext.ComponentQuery.query("#PanDeReg_txtDistrictName")[0];
            var MNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_MNP")[0];
            var UMNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_UMNP")[0];
            var NP=Ext.ComponentQuery.query("#optbtn_PanDeReg_NP")[0];
            var VD=Ext.ComponentQuery.query("#optbtn_PanDeReg_GBS")[0];

            if(Pan.getValue()==='')
            {
                msg("WARNING","कृपया स्था.ले.नं. नौ अंकको हाल्नुहोस् !",function(){Pan.focus();});
                me.ClearAllBeyondPan();
                return;
            }
            else
            {
                Pan=Ext.String.trim(Pan.getValue());

                Ext.Ajax.request({
                    url: '../Handlers/Registration/Taxpayer/TaxpayerHandler.ashx',
                    async : false,
                    params: {
                        method:'GetValidTaxpayerInfo',pan:Pan, acctType:'10'
                    },
                    success: function(response){

                        var obj =Ext.decode(response.responseText);
                        me.ClearAllBeyondPan();
                        if(obj.success === "true") 
                        {
                            var taxpayer=obj.root.Taxpayer;
                            var address=taxpayer.BusinessAddress.Address;
                            var office=taxpayer.Office;
                            if(document.getElementById("offCode").innerHTML!=office.OfficeCode)
                            {
                                msg('WARNING','कार्यालय :'+ document.getElementById("offCode").innerHTML+' मा यो स्था.ले.नं. उपलब्ध छैन !',function(){Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].focus();});
                                me.ClearAllBeyondPan();
                                return;
                            }

                            if(taxpayer!==null)
                            {
                                if(Ext.ComponentQuery.query('#DR_lblMsg')[0].text)
                                { me.ActiveDeActiveButtons('A','S','','F');
                                }
                                else
                                {
                                    me.ActiveDeActiveButtons('A','S','E','F');
                                }

                                if(taxpayer.AcctStatus=='D')
                                {
                                    me.ClearAllBeyondPan();
                                    me.ActiveDeActiveButtons('D','S','E','F');
                                    msg("WARNING","यो स्था.ले.नं. पहिला नै Deregistration भइसक्यो",function(){Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].focus();});
                                    return;
                                }
                                else
                                {
                                    Name.setValue(taxpayer.Name);
                                    Phone.setValue(address.Telephone);
                                    HouseNo.setValue(address.HouseNo);
                                    WardNo.setValue(address.WardNo);
                                    AreaName.setValue(address.StreetName);
                                    VDCName.setValue(address.VdcTown);
                                    DistrictName.setValue(address.DistrictNameNep);
                                    switch(address.LocationType)
                                    {
                                        case 'MM':
                                        MNP.setValue(true);
                                        break;
                                        case 'SM':
                                        UMNP.setValue(true);
                                        break;
                                        case 'MN':
                                        NP.setValue(true);
                                        break;
                                        case 'VD':
                                        VD.setValue(true);
                                        break;
                                        default:
                                        MNP.setValue(false);
                                        UMNP.setValue(false);
                                        NP.setValue(false);
                                        VD.setValue(false);
                                        break;
                                    }
                                    var Acnt=['PanDeReg_ddlDeRegFrom',
                                    'PanDeReg_txtAppDate',
                                    'PanDeReg_txtDeRegReason'];
                                    me.ActiveDeActiveControls('A',Acnt,'');


                                }
                            }              
                        }
                        else
                        {
                            me.ClearAllBeyondPan();
                            msg("WARNING","कृपया सही स्था.ले.नं. नौ अंकको हाल्नुहोस् !",function(){Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].focus();});
                            return; 
                        }              

                    },
                    failure:function(response)
                    {			
                        waitSave.hide();
                        msg('FAILURE',Ext.decode(response));
                    }
                });

            }
        }

    },

    onPanDeReg_btnSaveClick: function(button, e, options) {
        var me=this;

        var action=Ext.ComponentQuery.query('#hdnAction')[0].getValue();
        var status=Ext.ComponentQuery.query('#hdnStatus')[0].getValue();
        if(action==='')
        {
            action='A';
            Ext.ComponentQuery.query('#DR_lblMsg')[0].setText('');
        }
        if(status==='')
        status='I';


        var pan=Ext.ComponentQuery.query('#PanDeReg_txtPan')[0];
        var ddlDeRegFrom=Ext.ComponentQuery.query('#PanDeReg_ddlDeRegFrom')[0];
        var AppDate=Ext.ComponentQuery.query('#PanDeReg_txtAppDate')[0];
        var txtDeRegReason=Ext.ComponentQuery.query('#PanDeReg_txtDeRegReason')[0];

        var errMsg="";
        var errCount=0;

        if(!pan.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया स्था.ले.नं. हाल्नुहोस् !<br/>";
            pan.focus();
        }
        if(ddlDeRegFrom.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया कुन खाता बाट छान्नुहोस् !<br/>";
            ddlDeRegFrom.focus();
        }

        if(!AppDate.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया निवेदन मिति  हाल्नुहोस्  !<br/>";
            AppDate.focus();
        }

        if(errCount>0)
        {
            msg("WARNING",errMsg,function(){

                if(!pan.getValue())
                {    
                    pan.focus();
                }
                else if(ddlDeRegFrom.getValue()===null)
                {
                    ddlDeRegFrom.focus();
                }
                else if(!AppDate.getValue())
                {
                    AppDate.focus();
                }
            });    
            return false;
        }

        me.SaveDeRegistration(status,action); 
    },

    onPanDeReg_btnEditClick: function(button, e, options) {
        var me=this;
        Ext.ComponentQuery.query('#hdnAction')[0].setValue('E');
        Ext.ComponentQuery.query('#hdnStatus')[0].setValue('I');
        Ext.ComponentQuery.query('#DR_lblMsg')[0].setText('Updating...');


        var pan=Ext.ComponentQuery.query('#PanDeReg_txtPan')[0];
        var ddlDeRegFrom=Ext.ComponentQuery.query('#PanDeReg_ddlDeRegFrom')[0];
        var AppDate=Ext.ComponentQuery.query('#PanDeReg_txtAppDate')[0];
        var txtDeRegReason=Ext.ComponentQuery.query('#PanDeReg_txtDeRegReason')[0];
        me.ActiveDeActiveButtons('D','','E','');

        var errMsg="";
        var errCount=0;

        if(!pan.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया स्था.ले.नं. हाल्नुहोस् !<br/>";
            pan.focus();
        }
        if(ddlDeRegFrom.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया कुन खाता बाट छान्नुहोस् !<br/>";
            ddlDeRegFrom.focus();
        }

        if(!AppDate.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया निवेदन मिति  हाल्नुहोस्  !<br/>";
            AppDate.focus();
        }


        if(errCount>0)
        {
            msg("WARNING",errMsg,function(){pan.focus();});    
            return false;
        }

    },

    onPanDeReg_btnSubmitClick: function(button, e, options) {
        var me=this;
        var hdnAction=Ext.ComponentQuery.query('#hdnAction')[0];
        var pan=Ext.ComponentQuery.query('#PanDeReg_txtPan')[0];
        var ddlDeRegFrom=Ext.ComponentQuery.query('#PanDeReg_ddlDeRegFrom')[0];
        var AppDate=Ext.ComponentQuery.query('#PanDeReg_txtAppDate')[0];
        var txtDeRegReason=Ext.ComponentQuery.query('#PanDeReg_txtDeRegReason')[0];

        if(hdnAction.getValue()==='')
        {
            hdnAction.setValue("A"); 
        }

        var errMsg="";
        var errCount=0;

        if(!pan.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया स्था.ले.नं. हाल्नुहोस् !<br/>";
            pan.focus();
        }
        if(ddlDeRegFrom.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया कुन खाता बाट छान्नुहोस् !<br/>";
            ddlDeRegFrom.focus();
        }

        if(!AppDate.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया निवेदन मिति  हाल्नुहोस्  !<br/>";
            AppDate.focus();
        }

        if(errCount>0)
        {
            msg("WARNING",errMsg,function(){
                if(!pan.getValue())
                {
                    pan.focus();
                }
                else if(ddlDeRegFrom.getValue()===null)
                {
                    ddlDeRegFrom.focus();
                }
                else if(!AppDate.getValue())
                {
                    AppDate.focus(); 
                }

            });    
            return false;
        }
        else
        {
            Ext.Msg.confirm('Confirm Action', 'एकपटक Submit गरिसकेपछि अर्को पटक विवरण फेरि परिवर्तन गर्न पइने छैन। \n के तपाई Submit गर्न चाहनुहन्छ ?', function(btn) {
                if(btn == 'yes'){

                    me.SaveDeRegistration('F',hdnAction.getValue()); 


                }
            }
            );

        }
    },

    onPanDeReg_btnCancelClick: function(button, e, options) {
        this.ClearControl();
        Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].focus();
    },

    onPanDeReg_txtAppDateKeypress: function(textfield, e, options) {


        if(e.keyCode === 13 || e.keyCode === 9)
        {
            var me=this;
            var hdnAction=Ext.ComponentQuery.query('#hdnAction')[0];
            var hdnStatus=Ext.ComponentQuery.query('#hdnStatus')[0];
            var hdnTranNo=Ext.ComponentQuery.query('#hdnTranNo')[0];
            var Pan=Ext.ComponentQuery.query("#PanDeReg_txtPan")[0];
            var AccType=Ext.ComponentQuery.query("#PanDeReg_ddlDeRegFrom")[0];
            var AppDate=Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0];
            var DeRegReason=Ext.ComponentQuery.query("#PanDeReg_txtDeRegReason")[0];
            var lblMsg=Ext.ComponentQuery.query("#DR_lblMsg")[0];
            var Name=Ext.ComponentQuery.query("#PanDeReg_txtName")[0];
            var Phone=Ext.ComponentQuery.query("#PanDeReg_txtPhone")[0];
            var HouseNo=Ext.ComponentQuery.query("#PanDeReg_txtHouseNo")[0];
            var WardNo=Ext.ComponentQuery.query("#PanDeReg_txtWardNo")[0];
            var AreaName=Ext.ComponentQuery.query("#PanDeReg_txtAreaName")[0];
            var VDCName=Ext.ComponentQuery.query("#PanDeReg_txtVDCName")[0];
            var DistrictName=Ext.ComponentQuery.query("#PanDeReg_txtDistrictName")[0];
            var MNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_MNP")[0];
            var UMNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_UMNP")[0];
            var NP=Ext.ComponentQuery.query("#optbtn_PanDeReg_NP")[0];
            var VD=Ext.ComponentQuery.query("#optbtn_PanDeReg_GBS")[0];

            if(Pan.getValue()==='')
            {

                msg("WARNING","कृपया स्था.ले.नं. हाल्नुहोस् !",function(){ Pan.focus(true);});

                Name.reset();
                Phone.reset();
                HouseNo.reset();
                WardNo.reset();
                AreaName.reset();
                VDCName.reset();
                DistrictName.reset();
                MNP.reset();
                UMNP.reset();
                NP.reset();
                VD.reset();
                AccType.reset();
                AppDate.reset();
                DeRegReason.reset();

                return;

            }
            else if(AccType.getValue()===null)
            {

                msg("WARNING","कृपया कुन खाता बाट छान्नुहोस् !",function(){ AccType.focus(true);});
                return;

            }
            else if(AppDate.getValue()==='')
            {

                msg("WARNING","निवेदन मिति हाल्नुहोस् !",function(){AppDate.focus(true);});
                return;

            }
            else
            {
                /*
                var isValid = ValidatePan(Pan.getValue());
                if(isValid===false)
                {
                msg("WARNING","कृपया सही स्था.ले.नं. नौ अंकको हाल्नुहोस् !");
                Name.reset();
                Phone.reset();
                HouseNo.reset();
                WardNo.reset();
                AreaName.reset();
                VDCName.reset();
                DistrictName.reset();
                MNP.reset();
                UMNP.reset();
                NP.reset();
                VD.reset();
                AccType.reset();
                AppDate.reset();
                DeRegReason.reset();
                Pan.focus(true);

                return;
                }
                */

            }

            Ext.Ajax.request({
                url:"../Handlers/DeRegistration/DeRegistrationHandler.ashx?",
                params:{
                    method:'GetDeRegistration',
                    pan:Pan.getValue(),
                    AccType:AccType.getValue(),
                    appDate:AppDate.getValue()
                },

                success:function(result,request){
                    var obj=Ext.decode(result.responseText);

                    if(obj.success === "true")
                    {

                        DeRegReason.reset();
                        if(Ext.ComponentQuery.query('#DR_lblMsg')[0].text)
                        {
                            var rec=obj.root;
                            DeRegReason.setValue(rec.DeRegReason);
                            //hdnAction.setValue(rec.Action);
                            hdnStatus.setValue(rec.Status);
                            hdnTranNo.setValue(rec.TranNo);
                            var Acnt=[
                            'PanDeReg_txtDeRegReason'
                            ];
                            me.ActiveDeActiveControls('A',Acnt,'');
                            me.ActiveDeActiveButtons('A','S','','F');

                            if(rec.Status=='F')
                            {
                                msg("WARNING","स्था.ले.नं. दर्ता रदमा गएको डाटा पहिला नै FINALIZED भइसक्यो !",function(){ Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].focus(true);});

                                var Acnt=[
                                'PanDeReg_txtDeRegReason'
                                ];
                                me.ActiveDeActiveControls('D',Acnt,''); 
                                me.ActiveDeActiveButtons('D','S','E','F');
                            }

                            return;
                        }

                        if(obj.total!==0)
                        {
                            var Acnt=[
                            'PanDeReg_txtDeRegReason'
                            ];
                            me.ActiveDeActiveControls('D',Acnt,'');
                            me.ActiveDeActiveButtons('D','S','E','F');
                            msg("WARNING","यो विवरण पहिले देखी नै उपलब्ध छन !",function(){AppDate.focus();});
                            return;
                        }




                    }
                    else
                    {
                        //hdnAction.reset();
                        if(Ext.ComponentQuery.query('#DR_lblMsg')[0].text)
                        {
                            var Acnt=[
                            'PanDeReg_txtDeRegReason'
                            ];
                            DeRegReason.reset();
                            me.ActiveDeActiveControls('D',Acnt,'');
                            me.ActiveDeActiveButtons('D','S','E','F');
                            msg("WARNING","यो विवरण उपलब्ध छँन !",function(){AppDate.focus();});
                            return;

                        }
                        var Acnt=[
                        'PanDeReg_txtDeRegReason'
                        ];
                        DeRegReason.reset();
                        me.ActiveDeActiveControls('A',Acnt,'');
                        me.ActiveDeActiveButtons('A','S','','F'); 
                    }           
                },
                failure:function(result,request){

                    msg("FAILURE","Error in Fetching Data !!!");
                    return;

                }

            });

        }
    },

    onPanDeReg_txtAppDateBlur: function(field, options) {

        if(field.getValue()!=='')
        {
            return validateFutureDate(field.getValue(),"Y",function(){field.focus();});
        }

    },

    onPanDeReg_ddlDeRegFromSelect: function(combo, records, options) {

        Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].reset();


    },

    onFrmPanDeregistrationAfterRender: function(abstractcomponent, options) {
        var me=this;

        var Pan=Ext.ComponentQuery.query("#PanDeReg_txtPan")[0];
        var ddlDeRegFrom=Ext.ComponentQuery.query('#PanDeReg_ddlDeRegFrom')[0];
        var AppDate=Ext.ComponentQuery.query('#PanDeReg_txtAppDate')[0];
        var txtDeRegReason=Ext.ComponentQuery.query('#PanDeReg_txtDeRegReason')[0];
        var Name=Ext.ComponentQuery.query("#PanDeReg_txtName")[0];
        var Phone=Ext.ComponentQuery.query("#PanDeReg_txtPhone")[0];
        var HouseNo=Ext.ComponentQuery.query("#PanDeReg_txtHouseNo")[0];
        var WardNo=Ext.ComponentQuery.query("#PanDeReg_txtWardNo")[0];
        var AreaName=Ext.ComponentQuery.query("#PanDeReg_txtAreaName")[0];
        var VDCName=Ext.ComponentQuery.query("#PanDeReg_txtVDCName")[0];
        var DistrictName=Ext.ComponentQuery.query("#PanDeReg_txtDistrictName")[0];
        var MNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_MNP")[0];
        var UMNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_UMNP")[0];
        var NP=Ext.ComponentQuery.query("#optbtn_PanDeReg_NP")[0];
        var VD=Ext.ComponentQuery.query("#optbtn_PanDeReg_GBS")[0];

        var Parent=Ext.ComponentQuery.query('#frmPanDeregistration')[0];
        me.DeActiveAllControls(Parent);
        Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].setReadOnly(false);



        var objParam=Ext.ComponentQuery.query('#frmPanDeregistration')[0];

        if(objParam.extraParam!==undefined)
        {
            var params = objParam.extraParam.params;
            var tranNo = params.tranNo;

            Ext.Ajax.request({
                url:"../Handlers/DeRegistration/DeRegistrationHandler.ashx?method=GetDeRegistrationByTranNo",
                params:{tranNo:tranNo},
                success: function ( result, request ){

                    var obj = Ext.decode(result.responseText);
                    if(obj.success === "true")
                    {
                        Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].setReadOnly(true);
                        me.ActiveDeActiveButtons('D','S','E','F');
                        Ext.ComponentQuery.query('#PanDeReg_btnCancel')[0].disable();
                        var rec=obj.root;
                        if(rec.Pan && rec.AccType)
                        {
                            LoadTaxpayerInfoWithValidPan(rec.Pan,rec.AccType,function(data){

                                var taxpayer=data.root.Taxpayer;
                                var address=taxpayer.BusinessAddress.Address;
                                var office=taxpayer.Office;
                                console.log('tp',taxpayer);

                                if(taxpayer===null)
                                {
                                    return;
                                }


                                Pan.setValue(rec.Pan);
                                ddlDeRegFrom.setValue(rec.AccType);
                                AppDate.setValue(rec.AppDate);
                                txtDeRegReason.setValue(rec.DeRegReason);

                                Name.setValue(taxpayer.Name);
                                Phone.setValue(address.Telephone);
                                HouseNo.setValue(address.HouseNo);
                                WardNo.setValue(address.WardNo);
                                AreaName.setValue(address.StreetName);
                                VDCName.setValue(address.VdcTown);
                                DistrictName.setValue(address.DistrictNameNep);
                                switch(address.LocationType)
                                {
                                    case 'MM':
                                    MNP.setValue(true);
                                    break;
                                    case 'SM':
                                    UMNP.setValue(true);
                                    break;
                                    case 'MN':
                                    NP.setValue(true);
                                    break;
                                    case 'VD':
                                    VD.setValue(true);
                                    break;
                                    default:
                                    MNP.setValue(false);
                                    UMNP.setValue(false);
                                    NP.setValue(false);
                                    VD.setValue(false);
                                    break;
                                }    
                            }  );       
                        }

                    }
                    // msg(obj.success === "true"?"SUCCESS":"FAILURE",obj.message);

                    if(obj.success === "false") return;
                },
                failure: function ( result, request ){

                    msg("FAILURE","Error in Fetching Data !!!");
                    return;
                }
            });

            console.log(objParam);
            console.log(tranNo);
        }

    },

    onPanDeReg_ddlDeRegFromCollapse: function(field, options) {
        var me=this;
        var pan=Ext.ComponentQuery.query('#PanDeReg_txtPan')[0];
        var ddlDeRegFrom=Ext.ComponentQuery.query('#PanDeReg_ddlDeRegFrom')[0];

        if(!pan.getValue())
        {
            msg("WARNING","कृपया स्था.ले.नं. नौ अंकको हाल्नुहोस् !",function(){pan.focus();});
            me.ClearAllBeyondPan();
            return;  
        }


        Ext.Ajax.request({
            url:"../Handlers/DeRegistration/DeRegistrationHandler.ashx?method=CheckDergStatus",
            params:{pan:pan.getValue(),accttype:ddlDeRegFrom.getValue()},
            success:function(result,request){

                var obj=Ext.decode(result.responseText);
                if(obj.success=='true')
                {
                    console.log('M',obj.message);
                    if(obj.message!=='OK')
                    {
                        Ext.ComponentQuery.query('#PanDeReg_txtDeRegReason')[0].reset();
                        Ext.ComponentQuery.query('#PanDeReg_txtAppDate')[0].reset();
                        var Acnt=[
                        'PanDeReg_txtDeRegReason',
                        'PanDeReg_txtAppDate'
                        ];
                        me.ActiveDeActiveControls('D',Acnt,'');
                        me.ActiveDeActiveButtons('D','S','E','F');
                        msg("WARNING",obj.message);
                        return; 

                    }
                    else
                    {

                        Ext.ComponentQuery.query('#PanDeReg_txtAppDate')[0].setReadOnly(false);
                    }
                }

            },
            failure:function(result,request){

                msg("FAILURE","Error in Fetching Data !!!");
                return;

            }

        });

    },

    SaveDeRegistration: function(Status, Action) {
        var me=this;
        var Pan=Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].getValue();
        var AccType=Ext.ComponentQuery.query("#PanDeReg_ddlDeRegFrom")[0].getValue();
        var AppDate=Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].getValue();
        var DeRegReason=Ext.ComponentQuery.query("#PanDeReg_txtDeRegReason")[0].getValue();
        var TranNo=Ext.ComponentQuery.query("#hdnTranNo")[0].getValue();

        var loadMsg="";


        if(Action=="E")
        {
            loadMsg="Updating...";
        }
        else
        {

            loadMsg="Saving...";

        }

        if(Status!=="F")
        TranNo=null;



        var DeRegistration={
            Pan:Pan,
            AccType:AccType,
            AppDate:AppDate,
            DeRegReason:DeRegReason,
            Status:Status,
            Action:Action,
            TranDate:null,
            TranNo:TranNo

        };

        Ext.Ajax.request({
            url: '../Handlers/Registration/Taxpayer/TaxpayerHandler.ashx',
            params: {
                method:'GetValidTaxpayerInfo',pan:Pan, acctType:AccType
            },
            success: function(response){
                var obj =Ext.decode(response.responseText);
                if(obj.success==="false") 
                { 
                    me.ClearAllBeyondPan();
                    msg("WARNING","कृपया सही स्था.ले.नं. नौ अंकको हाल्नुहोस् !",function(){Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].focus();});
                    return;        
                }
                else
                {
                    var taxpayer=obj.root.Taxpayer;
                    var office=taxpayer.Office;
                    if(document.getElementById("offCode").innerHTML!=office.OfficeCode)
                    {
                        msg('WARNING','कार्यालय :'+ document.getElementById("offCode").innerHTML+' मा यो स्था.ले.नं. उपलब्ध छैन !',function(){Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].focus();});
                        me.ClearAllBeyondPan();
                        return;
                    }

                    Ext.Ajax.request({
                        url:"../Handlers/DeRegistration/DeRegistrationHandler.ashx?",
                        params:{
                            method:'GetDeRegistration',
                            pan:Pan,
                            AccType:AccType,
                            appDate:AppDate
                        },

                        success:function(result,request){
                            var obj=Ext.decode(result.responseText);
                            if(obj.success === "true")
                            {
                                if(!(Ext.ComponentQuery.query('#DR_lblMsg')[0].text))
                                {
                                    Ext.ComponentQuery.query("#PanDeReg_txtDeRegReason")[0].reset();
                                    if(obj.total!==0)
                                    {
                                        var Acnt=[
                                        'PanDeReg_txtDeRegReason'
                                        ];
                                        me.ActiveDeActiveControls('D',Acnt,'');
                                        me.ActiveDeActiveButtons('D','S','E','F');
                                        msg("WARNING","यो विवरण पहिले देखी नै उपलब्ध छन !",function(){Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].focus();});
                                        return;
                                    }  
                                }
                                else
                                {
                                    var waitSave=watiMsg(loadMsg);

                                    Ext.Ajax.request({
                                        url:"../Handlers/DeRegistration/DeRegistrationHandler.ashx?method=SaveDeRegistration",
                                        params:{DeRegistration:JSON.stringify(DeRegistration)},
                                        success: function ( result, request ){

                                            waitSave.hide();

                                            var obj = Ext.decode(result.responseText);

                                            msg(obj.success === "true" ?"SUCCESS":"FAILURE",obj.message);

                                            if(obj.success === "false") return;

                                        },

                                        failure: function ( result, request ){

                                            waitSave.hide();

                                            msg("FAILURE","Error in Fetching Data !!!");
                                            return;
                                        }


                                    });

                                    me.ClearControl();
                                }
                            }
                            else
                            {
                                if(Ext.ComponentQuery.query('#DR_lblMsg')[0].text)
                                {
                                    var Acnt=[
                                    'PanDeReg_txtDeRegReason'
                                    ];
                                    Ext.ComponentQuery.query("#PanDeReg_txtDeRegReason")[0].reset();
                                    me.ActiveDeActiveControls('D',Acnt,'');
                                    me.ActiveDeActiveButtons('D','S','E','F');
                                    msg("WARNING","यो विवरण उपलब्ध छँन !",function(){Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].focus();});
                                    return;

                                }

                                var waitSave=watiMsg(loadMsg);

                                Ext.Ajax.request({
                                    url:"../Handlers/DeRegistration/DeRegistrationHandler.ashx?method=SaveDeRegistration",
                                    params:{DeRegistration:JSON.stringify(DeRegistration)},
                                    success: function ( result, request ){

                                        waitSave.hide();

                                        var obj = Ext.decode(result.responseText);

                                        msg(obj.success === "true" ?"SUCCESS":"FAILURE",obj.message);

                                        if(obj.success === "false") return;

                                    },

                                    failure: function ( result, request ){

                                        waitSave.hide();

                                        msg("FAILURE","Error in Fetching Data !!!");
                                        return;
                                    }


                                });

                                me.ClearControl();

                            }           
                        },
                        failure:function(result,request){

                            msg("FAILURE","Error in Fetching Data !!!");
                            return;

                        }

                    });
                }
            },
            failure:function(result,request){

                msg("FAILURE","Error in Fetching Data !!!");
                return;

            }
        });

    },

    ActiveDeActiveButtons: function(Action, Save, Edit, Submit) {


        var PanDeReg_btnSave=Ext.ComponentQuery.query("#PanDeReg_btnSave")[0];
        var PanDeReg_btnEdit=Ext.ComponentQuery.query("#PanDeReg_btnEdit")[0];
        var PanDeReg_btnSubmit=Ext.ComponentQuery.query("#PanDeReg_btnSubmit")[0];



        if(Action==='D')
        {
            if(Save!=='' && Save==='S')
            {
                PanDeReg_btnSave.disable(true); 

            }
            else
            {
                PanDeReg_btnSave.enable(true);
            }

            if(Edit!=='' && Edit==='E')
            {
                PanDeReg_btnEdit.disable(true); 

            }
            else
            {
                PanDeReg_btnEdit.enable(true);
            }

            if(Submit!=='' && Submit==='F')
            {
                PanDeReg_btnSubmit.disable(true); 

            }
            else
            {
                PanDeReg_btnSubmit.enable(true);
            }

        }
        else if(Action==='A')
        {
            if(Save!=='' && Save==='S')
            {
                PanDeReg_btnSave.enable(true); 

            }
            else
            {
                PanDeReg_btnSave.disable(true);
            }

            if(Edit!=='' && Edit==='E')
            {
                PanDeReg_btnEdit.enable(true); 

            }
            else
            {
                PanDeReg_btnEdit.disable(true);
            }

            if(Submit!=='' && Submit==='F')
            {
                PanDeReg_btnSubmit.enable(true); 

            }
            else
            {
                PanDeReg_btnSubmit.disable(true); 
            }

        }
    },

    ClearControl: function() {
        var me=this;

        Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_ddlDeRegFrom")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtDeRegReason")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtName")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtPhone")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtHouseNo")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtWardNo")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtAreaName")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtVDCName")[0].reset();
        Ext.ComponentQuery.query("#PanDeReg_txtDistrictName")[0].reset();
        Ext.ComponentQuery.query("#optbtn_PanDeReg_MNP")[0].reset();
        Ext.ComponentQuery.query("#optbtn_PanDeReg_UMNP")[0].reset();
        Ext.ComponentQuery.query("#optbtn_PanDeReg_NP")[0].reset();
        Ext.ComponentQuery.query("#optbtn_PanDeReg_GBS")[0].reset();
        Ext.ComponentQuery.query('#hdnStatus')[0].reset();
        Ext.ComponentQuery.query('#hdnAction')[0].reset();
        Ext.ComponentQuery.query("#DR_lblMsg")[0].setText('');
        var Parent=Ext.ComponentQuery.query('#frmPanDeregistration')[0];
        me.ActiveDeActiveButtons('A','S','E','F');
        me.DeActiveAllControls(Parent);
        Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].setReadOnly(false);



    },

    ActiveDeActiveControls: function(Action, cntList, btnList) {


        if(Action=='A')
        {
            if(cntList.length!==0 && cntList!=='')
            {
                for (var i in cntList){

                    Ext.ComponentQuery.query('#'+ cntList[i])[0].setReadOnly(false);  

                }
            }

            if(btnList.length!==0 && btnList!=='')
            {
                for ( var a in btnList){

                    Ext.ComponentQuery.query('#'+ btnList[a])[0].enable(true);  

                }
            }


        }
        else if(Action=='D')
        {
            if(cntList.length!==0 && cntList!=='')
            {
                for (var d in cntList){

                    Ext.ComponentQuery.query('#'+ cntList[d])[0].setReadOnly(true);  

                }
            } 

            if(btnList.length!==0 && btnList!=='')
            {
                for (var b in btnList){

                    Ext.ComponentQuery.query('#'+ btnList[b])[0].disable(true);  

                }
            }


        }

    },

    DeActiveAllControls: function(ParentName) {

        //var pan=Ext.ComponentQuery.query('#frmPanDeregistration')[0];
        ParentName.query('.field,.combo').forEach(function(c){c.setReadOnly(true);});
        ParentName.query('.grid').forEach(function(c){ c.on('beforeedit', function(editor, e) { return false;});});
    },

    ClearAllBeyondPan: function() {
        var me=this;
        var accType=Ext.ComponentQuery.query("#PanDeReg_ddlDeRegFrom")[0].reset();
        var appDate=Ext.ComponentQuery.query("#PanDeReg_txtAppDate")[0].reset();
        var Reason=Ext.ComponentQuery.query("#PanDeReg_txtDeRegReason")[0].reset();
        var Name=Ext.ComponentQuery.query("#PanDeReg_txtName")[0].reset();
        var Phone=Ext.ComponentQuery.query("#PanDeReg_txtPhone")[0].reset();
        var HouseNo=Ext.ComponentQuery.query("#PanDeReg_txtHouseNo")[0].reset();
        var WardNo=Ext.ComponentQuery.query("#PanDeReg_txtWardNo")[0].reset();
        var AreaName=Ext.ComponentQuery.query("#PanDeReg_txtAreaName")[0].reset();
        var VDCName=Ext.ComponentQuery.query("#PanDeReg_txtVDCName")[0].reset();
        var DistrictName=Ext.ComponentQuery.query("#PanDeReg_txtDistrictName")[0].reset();
        var MNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_MNP")[0].reset();
        var UMNP=Ext.ComponentQuery.query("#optbtn_PanDeReg_UMNP")[0].reset();
        var NP=Ext.ComponentQuery.query("#optbtn_PanDeReg_NP")[0].reset();
        var VD=Ext.ComponentQuery.query("#optbtn_PanDeReg_GBS")[0].reset();
        //Ext.ComponentQuery.query("#DR_lblMsg")[0].setText('');
        var Parent=Ext.ComponentQuery.query('#frmPanDeregistration')[0];
        //me.ActiveDeActiveButtons('A','S','E','F');
        me.DeActiveAllControls(Parent);
        Ext.ComponentQuery.query("#PanDeReg_txtPan")[0].setReadOnly(false);


    },

    init: function(application) {
        this.control({
            "#PanDeReg_txtPan": {
                keypress: this.onPanDeReg_txtPanKeypress
            },
            "#PanDeReg_btnSave": {
                click: this.onPanDeReg_btnSaveClick
            },
            "#PanDeReg_btnEdit": {
                click: this.onPanDeReg_btnEditClick
            },
            "#PanDeReg_btnSubmit": {
                click: this.onPanDeReg_btnSubmitClick
            },
            "#PanDeReg_btnCancel": {
                click: this.onPanDeReg_btnCancelClick
            },
            "#PanDeReg_txtAppDate": {
                keypress: this.onPanDeReg_txtAppDateKeypress,
                blur: this.onPanDeReg_txtAppDateBlur
            },
            "#PanDeReg_ddlDeRegFrom": {
                select: this.onPanDeReg_ddlDeRegFromSelect,
                collapse: this.onPanDeReg_ddlDeRegFromCollapse
            },
            "#frmPanDeregistration": {
                afterrender: this.onFrmPanDeregistrationAfterRender
            }
        });
    }

});
