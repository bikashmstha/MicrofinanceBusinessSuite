/*
 * File: app/controller/DocUploadDo3.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.DocUploadDo3', {
    extend: 'Ext.app.Controller',

    stores: [
        'DocD03',
        'PageD03'
    ],

    onBtnBalanceSheetD03Click: function(button, e, eOpts) {
        var me = this;
        var form = button.up('form').getForm();
        var store = Ext.getStore("DocD03");

        console.log("store>>",store);


        if(form.isValid()){

            var pageNo = Ext.ComponentQuery.query('#cboBalanceSheetPgD03')[0].getValue();      

            var docID = "10001";

            var flag = store.find("PageNo",pageNo);    

            if(flag === 0)
            {
                msg("WARNING","Page No. already Exists !!!",function(){Ext.ComponentQuery.query('#cboBalanceSheetPgD03')[0].focus();});
                return;
            }

            me.Upload(docID,pageNo,store,form);

        }
    },

    onBtnCfsD03Click: function(button, e, eOpts) {
        var me = this;
        var form = button.up('form').getForm();
        var grd =  Ext.ComponentQuery.query('#grdCfsD03')[0];
        var store = grd.getStore();

        if(form.isValid()){

            var pageNo = Ext.ComponentQuery.query('#cboCfsPgD03')[0].getValue();
            var docID = "200002";

            var flag = store.find("PageNo",pageNo);

            if(flag === 0)
            {
                msg("WARNING","Page No. already Exists !!!",function(){Ext.ComponentQuery.query('#cboCfsPgD03')[0].focus();});
                return;
            }

            me.Upload(docID,pageNo,store,form);

        }
    },

    onBtnIncomeStmtD03Click: function(button, e, eOpts) {
        var me = this;
        var form = button.up('form').getForm();
        var grd =  Ext.ComponentQuery.query('#grdIncomeStmtD03')[0];
        var store = grd.getStore();

        if(form.isValid()){

            var pageNo = Ext.ComponentQuery.query('#cboIncomeStmtPgD03')[0].getValue();
            var docID = "100001";

            var flag = store.find("PageNo",pageNo);

            if(flag === 0)
            {
                msg("WARNING","Page No. already Exists !!!",function(){Ext.ComponentQuery.query('#cboIncomeStmtPgD03')[0].focus();});
                return;
            }

            me.Upload(docID,pageNo,store,form);

        }
    },

    onBtnFinRepAnxD03Click: function(button, e, eOpts) {
        var me = this;
        var form = button.up('form').getForm();
        var grd =  Ext.ComponentQuery.query('#grdFinRepAnxD03')[0];
        var store = grd.getStore();

        if(form.isValid()){

            var pageNo = Ext.ComponentQuery.query('#cboFinRepAnxPgD03')[0].getValue();
            var docID = "200001";

            var flag = store.find("PageNo",pageNo);

            if(flag === 0)
            {
                msg("WARNING","Page No. already Exists !!!",function(){Ext.ComponentQuery.query('#cboFinRepAnxPgD03')[0].focus();});
                return;
            }

            me.Upload(docID,pageNo,store,form);

        }
    },

    onBtnNotesToAcctD03Click: function(button, e, eOpts) {
        var me = this;
        var form = button.up('form').getForm();
        var grd =  Ext.ComponentQuery.query('#grdNotesToAcctD03')[0];
        var store = grd.getStore();

        if(form.isValid()){

            var pageNo = Ext.ComponentQuery.query('#cboNotesToAcctPgD03')[0].getValue();
            var docID = "100003";

            var flag = store.find("PageNo",pageNo);

            if(flag === 0)
            {
                msg("WARNING","Page No. already Exists !!!",function(){Ext.ComponentQuery.query('#cboNotesToAcctPgD03')[0].focus();});
                return;
            }

            me.Upload(docID,pageNo,store,form);

        }
    },

    onPnlDocUploadD03AfterRender: function(component, eOpts) {
        var me = this;
        var view = Ext.ComponentQuery.query('#pnlDocUploadD03')[0];
        var user = me.getController('MyApp.controller.LoginSecurity');  
        var param = "";

        if(view.extraParam === null)
        {
            user.clearSession();
            return;
        }

        param = view.extraParam;


        var store = Ext.getStore("DocD03");
        store.loadData([],false);


        var wait  = waitMsg('Loading Documents ...');

        Ext.Ajax.request({
            url: '../Handlers/IncomeTax/D03/DocumentUploadD03.ashx?method=Load',
            params:{submissionNo:param.submissionNo},
            async : false,
            success: function ( result, request ) {      

                wait.hide();

                var obj = Ext.decode(result.responseText); 

                if(obj.success === "false")
                {
                    msg("FAILURE",obj.message); 
                    return;
                }
                else
                {  
                    store.add(obj.root);         

                    var strCfs = deepCloneStore(store,"");
                    var strIncomeStmt = deepCloneStore(store,"");
                    var strFinRepAnx = deepCloneStore(store,"");
                    var strNotesToAcct = deepCloneStore(store,"");

                    store.filter("DocID","10001");
                    strCfs.filter("DocID","200002");
                    strIncomeStmt.filter("DocID","100001");
                    strFinRepAnx.filter("DocID","200001");
                    strNotesToAcct.filter("DocID","100003");


                    store.sort('PageNo','ASC');
                    strCfs.sort('PageNo','ASC');
                    strIncomeStmt.sort('PageNo','ASC');
                    strFinRepAnx.sort('PageNo','ASC');
                    strNotesToAcct.sort('PageNo','ASC');

                    var grdCfs = Ext.ComponentQuery.query('#grdCfsD03')[0];
                    var grdIncomeStmt =  Ext.ComponentQuery.query('#grdIncomeStmtD03')[0];
                    var grdFinRepAnx =  Ext.ComponentQuery.query('#grdFinRepAnxD03')[0];
                    var grdNotesToAcct =  Ext.ComponentQuery.query('#grdNotesToAcctD03')[0];

                    grdCfs.bindStore(strCfs);
                    grdIncomeStmt.bindStore(strIncomeStmt);
                    grdFinRepAnx.bindStore(strFinRepAnx);
                    grdNotesToAcct.bindStore(strNotesToAcct);

                }
            },
            failure:  function ( result, request ) { 

                wait.hide();

                msg("FAILURE","Error in Saving data !!!");        
            }
        });


    },

    onLaunch: function() {
        var me = this;
        var annexD03 = me.getController('MyApp.controller.SetAnnexD03');
        var param = me.validateParam();
        var el = Ext.get('lnkDocUploadD03');

        el.on('click', function(e,t,eOpts){

            param.action ="";

            annexD03.redirectToAnnexD03(param);
        });
    },

    validateParam: function() {
        var me = this;
        var view = Ext.ComponentQuery.query('#pnlDocUploadD03')[0];
        var user = me.getController('MyApp.controller.LoginSecurity');  
        var param = "";

        if(view.extraParam === null)
        {
            user.clearSession();

            return;

        }
        else
        {
            return view.extraParam;
        }
    },

    Upload: function(docID,pageNo,store,form) {
        var me = this;
        var param = me.validateParam();

        form.submit({
            url: '../Handlers/IncomeTax/D03/DocumentUploadD03.ashx?method=Upload',
            waitMsg: 'Uploading your photo...',
            params:{submissionNo:param.submissionNo,pageNo:pageNo,docID:docID},
            success: function(fp, o) {

                if(o.result.success)
                {

                    msg('Success', 'Processed file "' + o.result.fileName + '" on the server');

                    var row = {
                        PageNo:pageNo,
                        DocID:docID,
                        SubmissionNo:param.submissionNo,
                        FileName:o.result.fileName,
                        FileMimeType:o.result.fileMimeType
                    };

                    store.add(row);        
                    store.sort('PageNo','ASC');            

                }
                else
                {
                    msg("WARNING",o.result.message);
                }       
            }
        });

    },

    init: function(application) {
        this.control({
            "#btnBalanceSheetD03": {
                click: this.onBtnBalanceSheetD03Click
            },
            "#btnCfsD03": {
                click: this.onBtnCfsD03Click
            },
            "#btnIncomeStmtD03": {
                click: this.onBtnIncomeStmtD03Click
            },
            "#btnFinRepAnxD03": {
                click: this.onBtnFinRepAnxD03Click
            },
            "#btnNotesToAcctD03": {
                click: this.onBtnNotesToAcctD03Click
            },
            "#pnlDocUploadD03": {
                afterrender: this.onPnlDocUploadD03AfterRender
            }
        });
    }

});
