/*
 * File: app/view/D03Annex12.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.D03Annex12', {
    extend: 'Ext.panel.Panel',

    frame: true,
    height: 800,
    itemId: 'pnlD03Annex12',
    title: 'Annex-12',

    initComponent: function() {
        var me = this;

        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'form',
                    frame: true,
                    itemId: 'frmD03Annex12',
                    margin: 5,
                    autoScroll: true,
                    bodyPadding: 10,
                    items: [
                        {
                            xtype: 'label',
                            height: 50,
                            margin: '0 0 0 320',
                            maxHeight: 50,
                            style: 'font-size:20px',
                            text: 'अनुसूची -१२'
                        },
                        {
                            xtype: 'panel',
                            frame: true,
                            height: 500,
                            margin: '10 0 5 0',
                            autoScroll: true,
                            layout: {
                                columns: 1,
                                type: 'table'
                            },
                            title: 'पछाडि गएर अनुसूची तय गर्न <div id="lnkRedirectTopAnx12" style="cursor:pointer;color:red;display:inline;text-decoration:underline"><span>यहाँ कि्लक</span></div> गर्नुहोस् ।',
                            items: [
                                {
                                    xtype: 'panel',
                                    margin: '0 3 5 0',
                                    maxHeight: 800,
                                    width: 1020,
                                    autoScroll: true,
                                    title: 'विदेशमा तिरेको कर मिलान दावी',
                                    items: [
                                        {
                                            xtype: 'toolbar',
                                            height: 30,
                                            margin: 1,
                                            items: [
                                                {
                                                    xtype: 'button',
                                                    itemId: 'btnAddNewAnx12',
                                                    iconCls: 'icon-add',
                                                    text: 'Add New'
                                                }
                                            ]
                                        },
                                        {
                                            xtype: 'toolbar',
                                            items: [
                                                {
                                                    xtype: 'tbspacer',
                                                    width: 16
                                                },
                                                {
                                                    xtype: 'tbseparator'
                                                },
                                                {
                                                    xtype: 'label',
                                                    cls: 'LblCenter',
                                                    width: 191,
                                                    text: '१'
                                                },
                                                {
                                                    xtype: 'tbseparator'
                                                },
                                                {
                                                    xtype: 'label',
                                                    cls: 'LblCenter',
                                                    width: 141,
                                                    text: '२'
                                                },
                                                {
                                                    xtype: 'tbseparator'
                                                },
                                                {
                                                    xtype: 'label',
                                                    cls: 'LblCenter',
                                                    width: 141,
                                                    text: '३'
                                                },
                                                {
                                                    xtype: 'tbseparator'
                                                },
                                                {
                                                    xtype: 'label',
                                                    cls: 'LblCenter',
                                                    width: 131,
                                                    text: '४'
                                                },
                                                {
                                                    xtype: 'tbseparator'
                                                }
                                            ]
                                        },
                                        {
                                            xtype: 'gridpanel',
                                            height: 250,
                                            itemId: 'grdForeignTaxAnx12',
                                            margin: '0 0 5 0',
                                            maxHeight: 500,
                                            maxWidth: 400,
                                            style: 'z-index:1000;',
                                            autoScroll: true,
                                            store: 'DCTBForeignTaxDetails',
                                            columns: [
                                                {
                                                    xtype: 'rownumberer'
                                                },
                                                {
                                                    xtype: 'gridcolumn',
                                                    width: 200,
                                                    dataIndex: 'CountryCode',
                                                    text: 'आय स्रोतको मुलुक',
                                                    editor: {
                                                        xtype: 'combobox',
                                                        itemId: 'cboCountryAnx12',
                                                        width: 200,
                                                        emptyText: 'Select ...',
                                                        displayField: 'CountryName',
                                                        forceSelection: true,
                                                        queryMode: 'local',
                                                        store: 'CountryStore',
                                                        typeAhead: true,
                                                        valueField: 'CountryCode'
                                                    }
                                                },
                                                {
                                                    xtype: 'gridcolumn',
                                                    width: 150,
                                                    align: 'right',
                                                    dataIndex: 'FtcRemPreviousFy',
                                                    text: 'गत आयबर्ष सम्मको मिलान <br> गर्न बांकी  विदेशमा तिरेको कर ',
                                                    editor: {
                                                        xtype: 'textfield',
                                                        itemId: 'txtRemPreviousFyrAnx12',
                                                        fieldCls: 'TxtRight',
                                                        maskRe: /[0-9]/,
                                                        maxLength: 10
                                                    }
                                                },
                                                {
                                                    xtype: 'gridcolumn',
                                                    width: 150,
                                                    align: 'right',
                                                    dataIndex: 'FtcPaidCurrentFy',
                                                    text: 'यस आयबर्षमा विदेशमा तिरेको कर ',
                                                    editor: {
                                                        xtype: 'textfield',
                                                        itemId: 'txtPaidCurrentFyrAnx12',
                                                        fieldCls: 'TxtRight',
                                                        maskRe: /[0-9]/,
                                                        maxLength: 10
                                                    }
                                                },
                                                {
                                                    xtype: 'gridcolumn',
                                                    width: 140,
                                                    align: 'right',
                                                    dataIndex: 'FtcUsedCurrentFy',
                                                    text: 'यस आयबर्षमा विदेशी कर दावी',
                                                    editor: {
                                                        xtype: 'textfield',
                                                        itemId: 'txtUsedCurrentFyrAnx12',
                                                        fieldCls: 'TxtRight',
                                                        maskRe: /[0-9]/,
                                                        maxLength: 10
                                                    }
                                                },
                                                {
                                                    xtype: 'actioncolumn',
                                                    align: 'center',
                                                    items: [
                                                        {
                                                            handler: function(view, rowIndex, colIndex, item, e) {
                                                                var grd = Ext.ComponentQuery.query('#grdForeignTaxAnx12')[0];
                                                                var store = grd.getStore();
                                                                var row = store.getAt(rowIndex).data;

                                                                var txtSumRemPrevFyr = Ext.ComponentQuery.query('#txtSumRemPreviousFyrAnx12')[0];
                                                                var txtSumPaidCurrentFyr = Ext.ComponentQuery.query('#txtSumPaidCurrentFyrAnx12')[0];
                                                                var txtSumUsedCurrentFyr = Ext.ComponentQuery.query('#txtSumUsedCurrentFyrAnx12')[0];

                                                                var remPrevFyr  = row.FtcRemPreviousFy === null || row.FtcRemPreviousFy === "" ? 0:parseFloat(row.FtcRemPreviousFy);
                                                                var paidCurrFyr = row.FtcPaidCurrentFy === null || row.FtcPaidCurrentFy === "" ? 0:parseFloat(row.FtcPaidCurrentFy);
                                                                var usedCurrFyr = row.FtcUsedCurrentFy === null || row.FtcUsedCurrentFy === "" ? 0:parseFloat(row.FtcUsedCurrentFy);

                                                                var newSumRemPrevFyr = 0;
                                                                var newSumPaidCurrentFyr = 0;
                                                                var newSumUsedCurrentFyr = 0;

                                                                Ext.Msg.confirm('Confirm Action', 'Do you want to Remove ?', function(btn) {
                                                                    if(btn == 'yes'){


                                                                        newSumRemPrevFyr     = parseFloat(txtSumRemPrevFyr.getValue())-parseFloat(remPrevFyr);
                                                                        newSumPaidCurrentFyr = parseFloat(txtSumPaidCurrentFyr.getValue())-parseFloat(paidCurrFyr);
                                                                        newSumUsedCurrentFyr = parseFloat(txtSumUsedCurrentFyr.getValue())-parseFloat(usedCurrFyr);

                                                                        txtSumRemPrevFyr.setValue(newSumRemPrevFyr);
                                                                        txtSumPaidCurrentFyr.setValue(newSumPaidCurrentFyr);
                                                                        txtSumUsedCurrentFyr.setValue(newSumUsedCurrentFyr);

                                                                        if(row.Action === "E")
                                                                        {    
                                                                            row.Action = "D";
                                                                            grd.bindStore(store);         
                                                                            store.filter(function(item){
                                                                                return item.get("Action")!= 'D';
                                                                            });
                                                                        }
                                                                        else
                                                                        {
                                                                            store.removeAt(rowIndex);
                                                                        }
                                                                        return true;
                                                                    }
                                                                }, this);
                                                            },
                                                            icon: '../ITS/resources/images/icons/cancel.png',
                                                            iconCls: 'iconMargin'
                                                        }
                                                    ]
                                                }
                                            ],
                                            plugins: [
                                                Ext.create('Ext.grid.plugin.RowEditing', {
                                                    pluginId: 'pluginForeiginTaxAnx12',
                                                    listeners: {
                                                        validateedit: {
                                                            fn: me.onGridroweditingpluginValidateedit,
                                                            scope: me
                                                        },
                                                        canceledit: {
                                                            fn: me.onGridroweditingpluginCanceledit,
                                                            scope: me
                                                        }
                                                    }
                                                })
                                            ]
                                        },
                                        {
                                            xtype: 'toolbar',
                                            margin: '-3 0 0 0 ',
                                            items: [
                                                {
                                                    xtype: 'label',
                                                    margins: '0 126 0 21',
                                                    text: 'Total Expenses'
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    margins: '',
                                                    itemId: 'txtSumRemPreviousFyrAnx12',
                                                    width: 150,
                                                    fieldLabel: '',
                                                    fieldCls: 'TxtRight',
                                                    readOnly: true
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    itemId: 'txtSumPaidCurrentFyrAnx12',
                                                    margin: 0,
                                                    width: 147,
                                                    fieldCls: 'TxtRight',
                                                    readOnly: true
                                                },
                                                {
                                                    xtype: 'textfield',
                                                    itemId: 'txtSumUsedCurrentFyrAnx12',
                                                    margin: '0 0 0 1',
                                                    width: 138,
                                                    fieldCls: 'TxtRight',
                                                    readOnly: true
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    xtype: 'container',
                                    itemId: 'cntBtnAnx12',
                                    width: 1020,
                                    items: [
                                        {
                                            xtype: 'button',
                                            itemId: 'btnSubmitAnx12',
                                            padding: 5,
                                            iconCls: 'icon-ok',
                                            text: 'Save Annex 12'
                                        },
                                        {
                                            xtype: 'toolbar',
                                            margin: '5 0 5 0',
                                            items: [
                                                {
                                                    xtype: 'label',
                                                    html: 'पछाडि गएर अनुसूची तय गर्न',
                                                    text: ''
                                                },
                                                {
                                                    xtype: 'label',
                                                    html: '<a href="#" style="color:red"> यहाँ कि्लक  </a>',
                                                    itemId: 'lblRedirectAnx12',
                                                    text: 'My Label',
                                                    listeners: {
                                                        render: {
                                                            fn: me.onLblRedirectAnx1Render,
                                                            scope: me
                                                        }
                                                    }
                                                },
                                                {
                                                    xtype: 'label',
                                                    html: ' गर्नुहोस् । ',
                                                    text: 'My Label'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        });

        me.callParent(arguments);
    },

    onGridroweditingpluginValidateedit: function(editor, e, eOpts) {
        var i = 0; 
        var cboCountry = Ext.ComponentQuery.query('#cboCountryAnx12')[0];
        var country = cboCountry.getValue();

        var store = Ext.getStore('DCTBForeignTaxDetails');
        var count = store.findBy(
        function(record, id){

            if(i !== e.rowIdx && record.data.CountryCode === country)
            {
                return true;  // a record with this data exists
            }

            i++;

            return false;  // there is no record in the store with this data

        });


        if(count > -1)
        {
            msg("WARNING","Country already Exists !!!",function(){ cboCountry.focus();});

            return false;

        }


        var txtRemPreviousFyr = Ext.ComponentQuery.query('#txtRemPreviousFyrAnx12')[0];
        var txtPaidCurrentFyr = Ext.ComponentQuery.query('#txtPaidCurrentFyrAnx12')[0];
        var txtUsedCurrentFyr = Ext.ComponentQuery.query('#txtUsedCurrentFyrAnx12')[0];

        var valRemPrev = txtRemPreviousFyr.getValue();
        var valPaidCurrFyr = txtPaidCurrentFyr.getValue();
        var valUsedCurrFyr = txtUsedCurrentFyr.getValue();

        var objFocus = null;
        var errMsg = "";

        if(valRemPrev == null || valRemPrev == "")
        {
            errMsg += "कृपया 'गत आयबर्ष सम्मको मिलान  गर्न बांकी  विदेशमा तिरेको कर' राख्नुहोस्  !!! <br>";

            if(objFocus == null)
            {
                objFocus = txtRemPreviousFyr;
            }
        }


        if(valPaidCurrFyr == null || valPaidCurrFyr == "")
        {
            errMsg += "कृपया 'यस आयबर्षमा विदेशमा तिरेको कर' राख्नुहोस्  !!! <br>";

            if(objFocus == null)
            {
                objFocus = txtPaidCurrentFyr;
            }
        }

        if(valUsedCurrFyr == null || valUsedCurrFyr == "")
        {
            errMsg += "कृपया 'यस आयबर्षमा विदेशी कर दावी' राख्नुहोस्  !!! <br>";

            if(objFocus == null)
            {
                objFocus = txtUsedCurrentFyr;
            }
        }

        if(errMsg !== "")
        {
            msg("WARNING",errMsg,function(){ objFocus.focus();});
            return false;
        }

        return true;


        //return true;

    },

    onGridroweditingpluginCanceledit: function(editor, e, eOpts) {
        var grid = editor.grid;
        var cboCountry = Ext.ComponentQuery.query('#cboCountryAnx12')[0];
        var country = cboCountry.getValue();


        if(country == null || country == "")
        {
            grid.store.removeAt(editor.rowIdx);
        }
    },

    onLblRedirectAnx1Render: function(component, eOpts) {
        var c = component;

        c.getEl().on('click', function(){ this.fireEvent('click', c); }, c);
    }

});