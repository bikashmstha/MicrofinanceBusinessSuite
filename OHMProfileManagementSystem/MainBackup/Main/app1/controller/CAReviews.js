/*
 * File: app/controller/CAReviews.js
 *
 * This file was generated by Sencha Architect version 2.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.CAReviews', {
    extend: 'Ext.app.Controller',

    stores: [
        'AccountType',
        'CAR_strOfficeName',
        'NepaliMonthStore',
        'strCAReviews'
    ],

    onCAR_grdCAReviewsAfterRender: function(abstractcomponent, options) {
        var me=this;


        $(document).ready(function(){
            $("input[type='checkbox']").live("click", function(){ 

                var index=$("input[type='checkbox']").index(this);
                var str=Ext.getStore('strCAReviews');  
                str.getAt(index).set('SKIPREC',this.checked?'Y':'N');

            }
            );
        });


        var offCode=Ext.get('offCode').dom.innerHTML;
        var strOfficeName=Ext.getStore('CAR_strOfficeName');

        strOfficeName.removeAll();
        strOfficeName.load({
            params:{parentID:offCode}
        });


        me.GetLatestJob();
    },

    onCAR_btnSaveClick: function(button, e, options) {

        var me=this;
        var form=Ext.ComponentQuery.query('#frmCAReviews')[0].getForm(); 
        var OfficeName=Ext.ComponentQuery.query('#CAR_cmbOfficeName')[0];
        var Accttype=Ext.ComponentQuery.query('#CAR_cmdAccttype')[0];
        var year=Ext.ComponentQuery.query('#CAR_txtYear')[0];
        var month=Ext.ComponentQuery.query('#CAR_cmbMonth')[0];

        var errMsg="";
        var errCount=0;

        if(OfficeName.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया कार्यालयको नाम छान्नुहोस् !<br/>";
            OfficeName.focus();
        }
        if(Accttype.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया खाताको किसिम छान्नुहोस् !<br/>";
            Accttype.focus();
        }
        if(!year.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया बर्ष हाल्नुहोस्  !<br/>";
            year.focus();
        }
        if(month.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया महिना छान्नुहोस् !<br/>";
            month.focus();
        }
        if(errCount>0)
        {
            msg("WARNING",errMsg);    
            return false;
        }

        if(!form.isValid())
        {
            msg("WARNING","Please enter the required fields");
            Ext.ComponentQuery.query('#CAR_cmbMonth')[0].reset();
            Ext.ComponentQuery.query('#CAR_grdCAReviews')[0].store.removeAll();
            return;
        }
        else
        {
            var strCAReviews=Ext.getStore('strCAReviews');
            if(strCAReviews.count()!==0)
            {
                me.SaveCAReviews('','');

            }
            else
            {
                msg("WARNING","There is not any record to save in CA Reviews"); 
            }   
        }
    },

    onCAR_btnPostClick: function(button, e, options) {
        var me=this;

        me.PostCAReviews();
    },

    onCAR_cmbMonthCollapse: function(field, options) {
        var me=this;

        var form=Ext.ComponentQuery.query('#frmCAReviews')[0].getForm(); 
        var OfficeName=Ext.ComponentQuery.query('#CAR_cmbOfficeName')[0];
        var Accttype=Ext.ComponentQuery.query('#CAR_cmdAccttype')[0];
        var year=Ext.ComponentQuery.query('#CAR_txtYear')[0];
        var month=Ext.ComponentQuery.query('#CAR_cmbMonth')[0];
        //var btnSave=Ext.ComponentQuery.query('#CAR_btnSave')[0];

        var errMsg="";
        var errCount=0;

        if(OfficeName.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया कार्यालयको नाम छान्नुहोस् !<br/>";
            OfficeName.focus();
        }
        if(Accttype.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया खाताको किसिम छान्नुहोस् !<br/>";
            Accttype.focus();
        }
        if(!year.getValue())
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया बर्ष हाल्नुहोस्  !<br/>";
            year.focus();
        }
        if(month.getValue()===null)
        {
            errCount++;
            errMsg +=errCount+") "+"कृपया महिना छान्नुहोस् !<br/>";
            month.focus();
        }
        if(errCount>0)
        {
            msg("WARNING",errMsg);    
            return false;
        }

        if(!form.isValid())
        {
            msg("WARNING","Please enter the required fields");
            Ext.ComponentQuery.query('#CAR_cmbMonth')[0].reset();
            Ext.ComponentQuery.query('#CAR_grdCAReviews')[0].store.removeAll();
            return;
        }
        else
        {
            me.loadGrid();

        }




    },

    onCAR_btnCancelClick: function(button, e, options) {
        var me=this;
        me.ClearCAReviews();
    },

    onCAR_cmbOfficeNameCollapse: function(field, options) {
        Ext.ComponentQuery.query('#CAR_cmbMonth')[0].reset();
        Ext.ComponentQuery.query('#CAR_grdCAReviews')[0].store.removeAll();
    },

    onCAR_cmdAccttypeCollapse: function(field, options) {
        Ext.ComponentQuery.query('#CAR_cmbMonth')[0].reset();
        Ext.ComponentQuery.query('#CAR_grdCAReviews')[0].store.removeAll();
    },

    onCAR_txtYearBlur: function(field, options) {
        Ext.ComponentQuery.query('#CAR_cmbMonth')[0].reset();
        Ext.ComponentQuery.query('#CAR_grdCAReviews')[0].store.removeAll();
    },

    onCAR_btnCheckClick: function(button, e, options) {

        var PID=Ext.ComponentQuery.query('#CAR_txtPID')[0];
        var lblMsg=Ext.ComponentQuery.query('#CAR_lblMsg')[0];

        if(!PID.getValue())
        {
            msg("WARNING","Please enter a PID ");
            PID.focus();
            return;
        }

        Ext.Ajax.request({
            url:"../Handlers/Common/JobStatusHandler.ashx?method=GetJobStatusByRID",
            params:{
                RID:PID.getValue(),
                jobName:'CA_REV_POST'
            },
            success: function ( result, request ){

                var obj = Ext.decode(result.responseText);
                if(obj.success==="true")
                {
                    var rac=obj.root;

                    if(rac.JobST==='Y')
                    {
                        lblMsg.setText('Computer assessment reviews posted successfully.');
                        Ext.get('CAR_lblMsg').setStyle('color', 'green');   
                    }
                    else if(rac.JobST==='F')
                    {
                        lblMsg.setText('Computer Assessment Reviews Posted Faild. Error: '+ rac.JobError);
                        Ext.get('CAR_lblMsg').setStyle('color', 'red');   
                    }
                    else if(rac.JobST==='P')
                    {
                        lblMsg.setText('Computer assessment reviews is posting. Check it after some times');
                        Ext.get('CAR_lblMsg').setStyle('color', 'black');  
                    }
                    else
                    {
                        lblMsg.setText('Fristly, Post Computer Assessment Reviews');
                        Ext.get('CAR_lblMsg').setStyle('color', 'red'); 
                    }
                }

                if(obj.success === "false") return;

            },

            failure: function ( result, request ){

                waitSave.hide();

                msg("FAILURE","Error in Fetching Data !!!");
                return;
            }


        });

    },

    onFrmCAReviewsAfterRender: function(abstractcomponent, options) {
        Ext.ComponentQuery.query('#CAR_btnPost')[0].disable();
    },

    loadGrid: function() {
        var OfficeName=Ext.ComponentQuery.query('#CAR_cmbOfficeName')[0].getValue();
        var Accttype=Ext.ComponentQuery.query('#CAR_cmdAccttype')[0].getValue();
        var Year=Ext.ComponentQuery.query('#CAR_txtYear')[0].getValue();
        var Month=Ext.ComponentQuery.query('#CAR_cmbMonth')[0].getValue();
        var grd=Ext.ComponentQuery.query('#CAR_grdCAReviews')[0];

        var strCAReviews=Ext.getStore('strCAReviews');

        strCAReviews.removeAll();

        strCAReviews.load({
            params:{officeCode:OfficeName,
                accttype:Accttype,
                year:Year,
                month:Month
            }

        });

    },

    SaveCAReviews: function(Action, Status) {

        var me=this;


        var strCAReviews=Ext.getStore('strCAReviews');
        var cAReviewslst=getJson(strCAReviews);

        var waitSave=watiMsg("Saving...");
        Ext.Ajax.request({
            url:"../Handlers/VAT/ComputerAssessment/CAReviewsHandler.ashx?method=SaveCAReviews",
            params:{cAReviewslst:JSON.stringify(cAReviewslst)},
            success: function ( result, request ){
                waitSave.hide();

                var obj = Ext.decode(result.responseText);
                if(obj.success === "True")
                {
                    Ext.ComponentQuery.query('#CAR_btnPost')[0].enable(); 
                }

                msg(obj.success === "True" ?"SUCCESS":"FAILURE",obj.message);

                if(obj.success === "False") return;

            },

            failure: function ( result, request ){

                waitSave.hide();

                msg("FAILURE","Error in Fetching Data !!!");
                return;
            }


        });


    },

    PostCAReviews: function() {
        var OfficeName=Ext.ComponentQuery.query('#CAR_cmbOfficeName')[0].getValue();
        var Accttype=Ext.ComponentQuery.query('#CAR_cmdAccttype')[0].getValue();
        var Year=Ext.ComponentQuery.query('#CAR_txtYear')[0].getValue();
        var Month=Ext.ComponentQuery.query('#CAR_cmbMonth')[0].getValue();
        var lblMsg=Ext.ComponentQuery.query('#CAR_lblMsg')[0];
        var PID=Ext.ComponentQuery.query('#CAR_txtPID')[0];

        var waitSave=watiMsg("Posting...");

        Ext.Ajax.request({
            url:"../Handlers/VAT/ComputerAssessment/CAReviewsHandler.ashx?method=PostCAReviews",
            params:{
                officeCode:OfficeName,
                accttype:Accttype,
                year:Year,
                month:Month
            },
            success: function ( result, request ){
                waitSave.hide();

                var obj = Ext.decode(result.responseText);
                if(obj.success === "true")
                {
                    if(obj.message==='')
                    {
                        lblMsg.setText('Server is busy. Please post later on');
                        Ext.get('CAR_lblMsg').setStyle('color', 'red');   
                    }
                    else
                    {
                        lblMsg.setText('Computer Assessment Reviews is posting. Check it after some times');  
                        PID.setValue(obj.message);
                        Ext.get('CAR_lblMsg').setStyle('color', 'black'); 
                        Ext.ComponentQuery.query('#CAR_btnPost')[0].disable();
                    }        
                }


                if(obj.success === "false") return;

            },

            failure: function ( result, request ){

                waitSave.hide();

                msg("FAILURE","Error in Fetching Data !!!");
                return;
            }


        });

    },

    ClearCAReviews: function() {
        Ext.ComponentQuery.query('#CAR_cmbOfficeName')[0].reset();
        Ext.ComponentQuery.query('#CAR_cmbOfficeName')[0].focus();
        Ext.ComponentQuery.query('#CAR_cmdAccttype')[0].reset();
        Ext.ComponentQuery.query('#CAR_txtYear')[0].reset();
        Ext.ComponentQuery.query('#CAR_cmbMonth')[0].reset();
        Ext.ComponentQuery.query('#CAR_grdCAReviews')[0].store.removeAll();
        Ext.ComponentQuery.query('#CAR_lblMsg')[0].setText('');
        Ext.ComponentQuery.query('#CAR_txtPID')[0].reset();
        Ext.ComponentQuery.query('#CAR_btnPost')[0].disable();




    },

    GetLatestJob: function() {

        var PID=Ext.ComponentQuery.query('#CAR_txtPID')[0];
        var lblMsg=Ext.ComponentQuery.query('#CAR_lblMsg')[0];

        Ext.Ajax.request({
            url:"../Handlers/Common/JobStatusHandler.ashx?method=GetLatestJobStatus",
            params:{jobName:'CA_REV_POST'},
            success: function ( result, request ){

                var obj = Ext.decode(result.responseText);
                if(obj.success==="true")
                {
                    var rac=obj.root;

                    if(rac.JobST==='Y')
                    {
                        Ext.get('CAR_lblMsg').setStyle('color', 'green'); 
                        lblMsg.setText('Latest computer assessment reviews posted successfully. Your PID is '+rac.RID);
                        PID.setValue(rac.RID);
                        Ext.get('CAR_lblMsg').setStyle('color', 'green');   
                    }
                    else if(rac.JobST==='F')
                    {
                        lblMsg.setText('Latest CA Reviews Posted Faild. Error: '+ rac.JobError);
                        Ext.get('CAR_lblMsg').setStyle('color', 'red');   
                    }
                    else if(rac.JobST==='P')
                    {
                        lblMsg.setText('Latest Computer assessment reviews is posting. Check it after some times');
                        PID.setValue(rac.RID);
                    }

                }

                if(obj.success === "false") return;

            },

            failure: function ( result, request ){

                waitSave.hide();

                msg("FAILURE","Error in Fetching Data !!!");
                return;
            }


        });

    },

    init: function(application) {
        this.control({
            "#CAR_grdCAReviews": {
                afterrender: this.onCAR_grdCAReviewsAfterRender
            },
            "#CAR_btnSave": {
                click: this.onCAR_btnSaveClick
            },
            "#CAR_btnPost": {
                click: this.onCAR_btnPostClick
            },
            "#CAR_cmbMonth": {
                collapse: this.onCAR_cmbMonthCollapse
            },
            "#CAR_btnCancel": {
                click: this.onCAR_btnCancelClick
            },
            "#CAR_cmbOfficeName": {
                collapse: this.onCAR_cmbOfficeNameCollapse
            },
            "#CAR_cmdAccttype": {
                collapse: this.onCAR_cmdAccttypeCollapse
            },
            "#CAR_txtYear": {
                blur: this.onCAR_txtYearBlur
            },
            "#CAR_btnCheck": {
                click: this.onCAR_btnCheckClick
            },
            "#frmCAReviews": {
                afterrender: this.onFrmCAReviewsAfterRender
            }
        });
    }

});
