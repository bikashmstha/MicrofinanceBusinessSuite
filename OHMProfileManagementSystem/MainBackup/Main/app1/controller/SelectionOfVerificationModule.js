/*
 * File: app/controller/SelectionOfVerificationModule.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.SelectionOfVerificationModule', {
    extend: 'Ext.app.Controller',

    stores: [
        'Application',
        'AvaliableModule',
        'SelectionOfVerificationModule'
    ],

    onGrdSelVerModAplicationItemClick: function(dataview, record, item, index, e, eOpts) {
        var me=this;
        var appid = Ext.ComponentQuery.query('#grdSelVerModAplication')[0].getSelectionModel().getSelection()[0];
        Ext.getStore('AvaliableModule').load({params:{appId:appid.data.ApplicationID}});

        Ext.getStore('SelectionOfVerificationModule').loadData([],false);
        Ext.getStore('AvaliableModule').loadData([],false);
    },

    onGrdSelVerModModuleItemClick: function(dataview, record, item, index, e, eOpts) {

        var strVerModule =Ext.getStore('SelectionOfVerificationModule');
        strVerModule.removeAll();
        var selCount=Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().getSelection().length;

        if(selCount>0)
        {    
            for(var i=0;i<selCount;i++)
            {

                var ind= Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().getSelection()[i].index;
                var data=  Ext.getStore("AvaliableModule").data.items[ind].data.VerificationModules;
                strVerModule.loadData(data,true);

            }
        }

    },

    onBtntSelVerModAddClick: function(button, e, eOpts) {
        var me=this;
        /*
        var form = button.up('form').getForm();

        if(!form.isValid())
        {
        //msg("WARNING","Please Fill the required fields !!!");    
        return;
    }
    */
    if(this.validateAdd() === false)
    return false;

    var selectedApp = Ext.ComponentQuery.query('#grdSelVerModAplication')[0].getSelectionModel().getSelection()[0];
    var selectedModule =  Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().getSelection();
    var StrVerificationModules = Ext.getStore('SelectionOfVerificationModule');

    //var txtSelVerModVerifiactionLevel = Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].getValue();
    //var txtSelVerModFromDate =  Ext.ComponentQuery.query("#txtSelVerModFromDate")[0].getValue();

    var txtSelVerModVerifiactionLevel1 = Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0];
    var txtSelVerModFromDate1 =  Ext.ComponentQuery.query("#txtSelVerModFromDate")[0];
    var txtSelVerModVerifiactionLevel = txtSelVerModVerifiactionLevel1.getValue();
    var txtSelVerModFromDate = txtSelVerModFromDate1.getValue();



    var txtSelVerModToDate =  Ext.ComponentQuery.query("#txtSelVerModToDate")[0].getValue();

    var action='';

    if( Ext.ComponentQuery.query('#grdSelVerModuleDetails')[0].getSelectionModel().getCount()>0)
    {

        //action=Ext.ComponentQuery.query('#grdSelVerModuleDetails')[0].getSelectionModel().getSelection()[0].data.Action=="A"?"A":"E" ;
        action='A'; 
    }
    else
    {
        action='A';
    }


    for(var i = 0; i< selectedModule.length ; i++)
    {
        StrVerificationModules.add({ApplicationID:selectedApp.data.ApplicationID,
            ModuleID:selectedModule[i].data.ModuleID,
            FromDate:txtSelVerModFromDate,
            ToDate:txtSelVerModToDate,
            LevelOfVerification:txtSelVerModVerifiactionLevel,
            Action:action
        });

    }

    Ext.ComponentQuery.query('#grdSelVerModuleDetails')[0].bindStore(StrVerificationModules); 

    txtSelVerModVerifiactionLevel1.setValue("");
    txtSelVerModFromDate1.setValue("");
    txtSelVerModFromDate1.clearInvalid();
    txtSelVerModVerifiactionLevel1.clearInvalid();

    },

    onBtnSelVerModSubmitClick: function(button, e, eOpts) {
        var me=this;

        if(this.validateSubmit() === false)
        return false;
        /*
        var form = button.up('form').getForm();

        if(!form.isValid())
        {
        //msg("WARNING","Please Fill the required fields !!!");    
        return;
    }
    */
    var strVerifiedModule= Ext.ComponentQuery.query('#grdSelVerModuleDetails')[0].getStore();

    strVerifiedModule.filter(function(item){
        return (item.get("Action")== 'A' || item.get("Action")== 'E');
    });

    var postData=getJson(strVerifiedModule);


    Ext.Ajax.request({
        url: '../Handlers/Verification/VerificationModuleHandler.ashx?method=SaveVerificationModule',
        params: {verificationModule:JSON.stringify(postData)},
        success: function ( result, request ) {

            msg('SUCCESS','Data Saved Successfully'); //clearInvalid();
            Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].setValue("");
            Ext.ComponentQuery.query("#txtSelVerModFromDate")[0].setValue("");
            Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].clearInvalid();
            Ext.ComponentQuery.query("#txtSelVerModFromDate")[0].clearInvalid();
            Ext.ComponentQuery.query("#txtSelVerModToDate")[0].setValue("");
            Ext.ComponentQuery.query('#grdSelVerModuleDetails')[0].getSelectionModel().deselectAll();
            Ext.ComponentQuery.query('#grdSelVerModAplication')[0].getSelectionModel().deselectAll();
            Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().deselectAll();
            Ext.getStore('SelectionOfVerificationModule').loadData([],false);
            Ext.getStore('AvaliableModule').loadData([],false);

        },
        failure: function ( result, request ) {

            msg('FAILURE','Operation Failed');      
        }

    });



    },

    onGrdSelVerModuleDetailsItemClick: function(dataview, record, item, index, e, eOpts) {
        /*
        Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].setValue(record.data.LevelOfVerification);
        Ext.ComponentQuery.query("#txtSelVerModFromDate")[0].setValue(record.data.FromDate);
        Ext.ComponentQuery.query("#txtSelVerModToDate")[0].setValue(record.data.ToDate);
        */
    },

    onBtnSelVerModCancelClick: function(button, e, eOpts) {
        Ext.getStore('SelectionOfVerificationModule').loadData([],false);
        Ext.getStore('AvaliableModule').loadData([],false);   
        Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].setValue("");
        Ext.ComponentQuery.query("#txtSelVerModFromDate")[0].setValue("");
        Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].clearInvalid();
        Ext.ComponentQuery.query("#txtSelVerModFromDate")[0].clearInvalid();
        Ext.ComponentQuery.query("#txtSelVerModToDate")[0].setValue("");
        Ext.ComponentQuery.query('#grdSelVerModuleDetails')[0].getSelectionModel().deselectAll();
        Ext.ComponentQuery.query('#grdSelVerModAplication')[0].getSelectionModel().deselectAll();
        Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().deselectAll();

    },

    validateAdd: function() {
        var selectedApp = Ext.ComponentQuery.query('#grdSelVerModAplication')[0].getSelectionModel().getSelection();
        var selectedModule =  Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().getSelection();
        var txtSelVerModVerifiactionLevel = Ext.ComponentQuery.query("#txtSelVerModVerifiactionLevel")[0].getValue();

        var count = 0;
        var errorMsg = "";

        if(selectedApp.length < 1)
        {

            count++;
            errorMsg = count + ") Please Select Application first !!!";

        }
        else if(selectedModule.length < 1)
        {
            count++;
            errorMsg = errorMsg +'<br/>'+ count + ") Please Select Module !!!";
        }


        if(txtSelVerModVerifiactionLevel === "")
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ") Please Enter Verifiaction Level!!!";

        }

        if(count >0)
        {
            msg("WARNING",errorMsg);
            return false;
        }


    },

    validateSubmit: function() {
        var selectedApp = Ext.ComponentQuery.query('#grdSelVerModAplication')[0].getSelectionModel().getSelection();
        var selectedModule =  Ext.ComponentQuery.query('#grdSelVerModModule')[0].getSelectionModel().getSelection();


        var count = 0;
        var errorMsg = "";

        if(selectedApp.length < 1)
        {

            count++;
            errorMsg = count + ") Please Select Application first !!!";

        }
        else if(selectedModule.length < 1)
        {
            count++;
            errorMsg = errorMsg +'<br/>'+ count + ") Please Select Module !!!";
        }


        if(count >0)
        {
            msg("WARNING",errorMsg);
            return false;
        }

    },

    init: function(application) {
        this.control({
            "#grdSelVerModAplication": {
                itemclick: this.onGrdSelVerModAplicationItemClick
            },
            "#grdSelVerModModule": {
                itemclick: this.onGrdSelVerModModuleItemClick
            },
            "#btntSelVerModAdd": {
                click: this.onBtntSelVerModAddClick
            },
            "#btnSelVerModSubmit": {
                click: this.onBtnSelVerModSubmitClick
            },
            "#grdSelVerModuleDetails": {
                itemclick: this.onGrdSelVerModuleDetailsItemClick
            },
            "#btnSelVerModCancel": {
                click: this.onBtnSelVerModCancelClick
            }
        });
    }

});
