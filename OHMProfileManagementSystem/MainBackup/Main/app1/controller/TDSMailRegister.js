/*
 * File: app/controller/TDSMailRegister.js
 *
 * This file was generated by Sencha Architect version 3.0.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.TDSMailRegister', {
    extend: 'Ext.app.Controller',

    models: [
        'TDSRegStatus'
    ],
    stores: [
        'TDSRegStatus'
    ],

    onBtnMRTDSRegisterClick: function(button, e, eOpts) {
        var me = this;

        me.SaveEdit("I");
    },

    onBtnMRTDSRequestKeyClick: function(button, e, eOpts) {
        var me = this;

        var hdnMail = Ext.ComponentQuery.query("#hdnMRTDSMail")[0];
        var hdnPan = Ext.ComponentQuery.query("#hdnMRTDSPan")[0];

        me.getController('MyApp.controller.TDSRequestKey').init();
        me.getController('MyApp.controller.TDSRequestKey').ShowReqKey(hdnPan.getValue(),hdnMail.getValue());
    },

    ShowMailReg: function() {
        Ext.getCmp('cntOMTDS').removeAll();

        var pnlDynamic = Ext.create('MyApp.view.TDSMailRegister');

        var btnRequestKey = Ext.ComponentQuery.query("#btnMRTDSRequestKey")[0];
        btnRequestKey.setVisible(false);

        var pnlToRender = Ext.ComponentQuery.query("#cntOMTDS")[0];
        pnlToRender.add(pnlDynamic);

    },

    SaveEdit: function(arg) {
        var me = this;

        var txtPan = Ext.ComponentQuery.query("#txtMRTDSPan")[0];
        var txtPhone = Ext.ComponentQuery.query("#txtMRTDSPhone")[0];
        var txtAdd = Ext.ComponentQuery.query("#txtMRTDSAddress")[0];
        var txtEmail = Ext.ComponentQuery.query("#txtMRTDSEmailAdd")[0];
        var cboStatus = Ext.ComponentQuery.query("#cboMRTDSStatus")[0];

        var form = Ext.ComponentQuery.query("#frmMRTDSform")[0].getForm();

        if(!form.isValid())
        {
            msg("WARNING","Please enter required fields");
            return false;
        }

        var param = {
            PAN:txtPan.getValue(),
            Email:txtEmail.getValue(),
            ContactNo:txtPhone.getValue(),
            Address:txtAdd.getValue(),
            Status:cboStatus.getValue(),
            RecordStatus:arg
        };

        var waitSave = watiMsg('Loading...');

        Ext.Ajax.request({
            url:"../Handlers/TDS/RegisterEmailHandler.ashx?method=RegisterMail",
            params: {objReg:JSON.stringify(param)},
            success: function ( result, request ){

                waitSave.hide();

                var obj = Ext.decode(result.responseText);
                var data = obj.root;

                var dpmsg = Ext.ComponentQuery.query("#dpMRTDSmsg")[0];
                var btnRequestKey = Ext.ComponentQuery.query("#btnMRTDSRequestKey")[0];
                var hdnMail = Ext.ComponentQuery.query("#hdnMRTDSMail")[0];
                var hdnPan = Ext.ComponentQuery.query("#hdnMRTDSPan")[0];

                if(obj.success === "true")
                {
                    msg("SUCCESS",obj.message);
                    me.Clear();
                    dpmsg.setValue('Your Email ID with PAN number is successfully registered, Now you can Request Key!');
                    btnRequestKey.setVisible(true);
                    hdnPan.setValue(data.PAN);
                    hdnMail.setValue(data.Email);

                    //  me.getController('MyApp.controller.TDSWithholdLoggedIn').ShowWHLoggedIn(hdnpan.getValue());
                }
                else if(obj.success === "false")
                {
                    msg("FAILURE",obj.message);
                    return;
                }

            },

            failure: function ( result, request ){

                return;
            }

        });
    },

    Clear: function() {
        var txtPan = Ext.ComponentQuery.query("#txtMRTDSPan")[0];
        var txtPhone = Ext.ComponentQuery.query("#txtMRTDSPhone")[0];
        var txtAdd = Ext.ComponentQuery.query("#txtMRTDSAddress")[0];
        var txtEmail = Ext.ComponentQuery.query("#txtMRTDSEmailAdd")[0];
        var cboStatus = Ext.ComponentQuery.query("#cboMRTDSStatus")[0];

        txtPan.setValue('');
        txtPan.clearInvalid();
        txtPhone.setValue('');
        txtPhone.clearInvalid();
        txtAdd.setValue('');
        txtAdd.clearInvalid();
        txtEmail.setValue('');
        txtEmail.clearInvalid();
        cboStatus.setValue('');
        cboStatus.clearInvalid();
    },

    init: function(application) {
        this.control({
            "#btnMRTDSRegister": {
                click: this.onBtnMRTDSRegisterClick
            },
            "#btnMRTDSRequestKey": {
                click: this.onBtnMRTDSRequestKeyClick
            }
        });
    }

});
