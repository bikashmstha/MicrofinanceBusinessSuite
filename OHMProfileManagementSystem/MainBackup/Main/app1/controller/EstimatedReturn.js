/*
 * File: app/controller/EstimatedReturn.js
 *
 * This file was generated by Sencha Architect version 2.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.EstimatedReturn', {
    extend: 'Ext.app.Controller',

    stores: [
        'Est_Ret_Type',
        'Est_Ret_VoucherList',
        'RevenueAccountStore',
        'EstPaymentMode',
        'OfficeBankInfo',
        'FiscalYear'
    ],

    onFrm_EstimatedReturnAfterRender: function(abstractcomponent, options) {
        //Ext.getStore('Est_Ret_VoucherList').loadData([],false);

        var Est_Ret_Type = Ext.getStore('Est_Ret_Type');
        Est_Ret_Type.clearFilter();
        if(Est_Ret_Type.getCount() > 0)
        {
            Est_Ret_Type.filter(function(item){
                return item.get("TypeID")!= 'RN';
            });
        }
        Est_Ret_Type.loadData([],true);
    },

    onEst_Ret_AddVoucherClick: function(button, e, options) {
        var hdnEst_Ret_Office_Code = Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0].getValue();
        var txtEst_Ret_PanNo =  Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].getValue();
        var txtEst_Ret_AccType = Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].getValue();

        var ddlEstFysicalYear = Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].getValue();
        var ddlEst_Ret_ReturnType = Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0].getValue();


        var count = 0;
        var errorMsg = "";
        /*
        if(hdnEst_Ret_Office_Code === "")
        {

        count++;
        errorMsg = errorMsg +'<br/>'+ count + ") कृपया कार्यालय कोड भर्नुहोस्!!!";

        }
        */







        //alert(ddlEstFysicalYear);
        if(ddlEst_Ret_ReturnType === null )
        {

            count++;
            errorMsg = errorMsg + '<br/>'+ count + ") कृपया अनुमानित करको प्रकार छान्नुहोस् !!!";

        }



        if(txtEst_Ret_PanNo === "")
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ") कृपया स्था . ले . नं . भर्नुहोस् !!!";

        }

        if(txtEst_Ret_AccType === "")
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ")कृपया खाताको किसिम  भर्नुहोस् !!!";

        }

        if(ddlEstFysicalYear === null)
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ")कृपया आय बर्ष छान्नुहोस् !!! ";

        }

        if(count >0)
        {
            msg("WARNING",errorMsg);
            return false;
        }


        var VoucherStore = Ext.getStore('Est_Ret_VoucherList');

        var ddlEst_Ret_Treasure_Acct_No = Ext.ComponentQuery.query('#ddlEst_Ret_Treasure_Acct_No')[0];
        var ddlEst_Ret_Payment_mode = Ext.ComponentQuery.query('#ddlEst_Ret_Payment_mode')[0];
        var txtEst_Ret_Voucher_No = Ext.ComponentQuery.query('#txtEst_Ret_Voucher_No')[0];
        var ddlEst_Ret_Bank_Code = Ext.ComponentQuery.query('#ddlEst_Ret_Bank_Code')[0];
        var txtEst_Ret_Entered_Date = Ext.ComponentQuery.query('#txtEst_Ret_Entered_Date')[0];
        var txtEst_Ret_Amount = Ext.ComponentQuery.query('#txtEst_Ret_Amount')[0];

        var grd = Ext.ComponentQuery.query('#Est_Ret_VoucherList')[0];

        var rec={
            Sno:null,
            TreasureAcctNo:'',
            PaymentMode:'',
            VoucherNo:'',
            PaymentDate:'',
            Amount:null,
            EnteredBy:''

        };

        if(grd.store.add(rec))
        {
            var btnAddAddVoucher= Ext.ComponentQuery.query('#Est_Ret_AddVoucher')[0];
            btnAddAddVoucher.disable(true);
        }

        //grd.store.add(rec);
        //console.log('store ',grd.store.data);
        var col = grd.headerCt.getHeaderAtIndex(0);
        var recd = grd.store.data.items;
        var record = recd[recd.length-1];
        grd.getPlugin('Est_Ret_RowEdtPlgn').startEdit(record, col);




    },

    onEst_Ret_VoucherListBeforeRender: function(abstractcomponent, options) {
        var grid = Ext.ComponentQuery.query('#Est_Ret_VoucherList')[0];

        grid.columns[1].renderer = function(value, metaData, record, rowIndex, colIndex, store, view) {
            var temp="";    

            var items = Ext.getStore('RevenueAccountStore').data.items;

            for(var i=0;i<items.length;i++)
            {        
                if(items[i].data.AccountCode == value)
                {           
                    temp=items[i].data.AccountCode;
                    break;
                }        
            }

            return temp;



        };


        grid.columns[2].renderer = function(value, metaData, record, rowIndex, colIndex, store, view) {
            var temp="";    

            var items = Ext.getStore('EstPaymentMode').data.items;

            for(var i=0;i<items.length;i++)
            {        
                if(items[i].data.EstPaymentModeID == value)
                {           
                    temp=items[i].data.EstPaymentModeName;
                    break;
                }        
            }

            return temp;



        };
        grid.columns[4].renderer = function(value, metaData, record, rowIndex, colIndex, store, view) {
            var temp="";    

            var items = Ext.getStore('OfficeBankInfo').data.items;

            console.log("bankInfo",items);
            console.log("value",value);

            for(var i=0;i<items.length;i++)
            {        
                if(items[i].data.BankBr == value)
                {           
                    temp=items[i].data.BankName;
                    break;
                }        
            }

            return temp;

        };




    },

    onTxtEst_Ret_PanNoKeypress: function(textfield, e, options) {
        if(e.keyCode === 13 || e.keyCode === 9)
        {

            this.PanCurrentOfficeTaxpayerInfo();


        }



    },

    onTxtEst_Ret_IncomeBlur: function(field, options) {
        var me = this;
        me.calProfitLoss();
    },

    onTxtEst_Ret_DeductionsBlur: function(field, options) {
        var me = this;
        me.calProfitLoss();
    },

    onTxtEst_Ret_Exempt_AmountBlur: function(field, options) {
        var me = this;
        me.calProfitLoss();
    },

    onTxtEst_Ret_Income_Oth_Bus_InvBlur: function(field, options) {
        var row4= Ext.ComponentQuery.query('#txtEst_Ret_Assessable_Income')[0]; 
        var row5=field;
        var row6=Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0]; 
        var total="0.00";

        var val4 = getFloat(row4.getValue()); 
        var val5 = getFloat(row5.getValue()); 

        total = (val4 + val5);


        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
            total   =  arr[0]+"."+arr[1].substring(0,2);
            if(arr[1].length==1)
            {
                total=total+"0";
            }
        }


        /*
        if(row4.value && row5.value)
        {
        if(row4.validate()&& row5.validate())
        {
        total=Number(row4.value) + Number(row5.value);
        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
        total   =  arr[0]+"."+arr[1].substring(0,2);
        if(arr[1].length==1)
        {
        total=total+"0";
        }
        }
        }
        }
        */
        row6.setValue(total);
    },

    onTxtEst_Ret_Donation_To_Exempt_OrgBlur: function(field, options) {
        //alert(7);
        var row6=Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0]; 
        var row7=field;
        var row8=Ext.ComponentQuery.query('#txtEst_Ret_Retirement_Contribution')[0]; 
        var row9=Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0]; 
        var total="0.00";

        var val6 = getFloat(row6.getValue()); 
        var val7 = getFloat(row7.getValue());
        var val8 = getFloat(row8.getValue()); 

        total = (val6 -(val7 + val8));

        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
            total   =  arr[0]+"."+arr[1].substring(0,2);
            if(arr[1].length==1)
            {
                total=total+"0";
            }
        }

        /*
        if(row6.value && row7.value && row8.value)
        {
        if(row6.validate()&& row7.validate()&& row8.validate())
        {
        total=Number(row6.value) -( Number(row7.value) + Number(row8.value));
        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
        total   =  arr[0]+"."+arr[1].substring(0,2);
        if(arr[1].length==1)
        {
        total=total+"0";
        console.debug("");
        }
        }
        }
        }
        */
        row9.setValue(total);
        //alert(7);
    },

    onTxtEst_Ret_Retirement_ContributionBlur: function(field, options) {
        //alert(8);
        var row6=Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0];
        var row7=Ext.ComponentQuery.query('#txtEst_Ret_Donation_To_Exempt_Org')[0]; 
        var row8=field; 
        var row9=Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0]; 
        var total="0.00";


        var val6 = getFloat(row6.getValue()); 
        var val7 = getFloat(row7.getValue());
        var val8 = getFloat(row8.getValue());

        total = (val6 - (val7 + val8));

        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
            total   =  arr[0]+"."+arr[1].substring(0,2);
            if(arr[1].length==1)
            {
                total=total+"0";
            }
        }



        /*
        if(row6.value && row7.value && row8.value)
        {
        if(row6.validate()&& row7.validate()&& row8.validate())
        {
        total=Number(row6.value) -( Number(row7.value) + Number(row8.value));
        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
        total   =  arr[0]+"."+arr[1].substring(0,2);
        if(arr[1].length==1)
        {
        total=total+"0";
        console.debug("");
        }
        }
        }
        }
        */
        row9.setValue(total);
        //alert(8);
    },

    onTxtEst_Ret_Assessable_IncomeChange: function(field, newValue, oldValue, options) {
        var row4= field; 
        var row5=Ext.ComponentQuery.query('#txtEst_Ret_Income_Oth_Bus_Inv')[0];
        var row6=Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0]; 
        var total="0.00";

        var val4 = getFloat(row4.getValue()); 
        var val5 = getFloat(row5.getValue());


        total =  (val4 + val5) ;

        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
            total   =  arr[0]+"."+arr[1].substring(0,2);
            if(arr[1].length==1)
            {
                total=total+"0";
            }
        } 


        /*
        if(row4.value && row5.value)
        {
        if(row4.validate()&& row5.validate())
        {
        total=Number(row4.value) + Number(row5.value);
        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
        total   =  arr[0]+"."+arr[1].substring(0,2);
        if(arr[1].length==1)
        {
        total=total+"0";
        }
        }
        }
        }
        */
        row6.setValue(total);
    },

    onTxtEst_Ret_Total_Assessable_IncomeChange: function(field, newValue, oldValue, options) {
        //alert(6);
        var row6=field;
        var row7=Ext.ComponentQuery.query('#txtEst_Ret_Donation_To_Exempt_Org')[0]; 
        var row8=Ext.ComponentQuery.query('#txtEst_Ret_Retirement_Contribution')[0]; 
        var row9=Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0]; 
        var total="0.00";

        var val6 = getFloat(row6.getValue()); 
        var val7 = getFloat(row7.getValue());
        var val8 = getFloat(row8.getValue());


        total =  (val6 - (val7 + val8))  ;

        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
            total   =  arr[0]+"."+arr[1].substring(0,2);
            if(arr[1].length==1)
            {
                total=total+"0";
            }
        }




        /*
        if(row6.value && row7.value && row8.value)
        {
        if(row6.validate()&& row7.validate()&& row8.validate())
        {
        total=Number(row6.value) -( Number(row7.value) + Number(row8.value));
        var arr =  String.split(total,'.');
        if(arr.length>1)
        {
        total   =  arr[0]+"."+arr[1].substring(0,2);
        if(arr[1].length==1)
        {
        total=total+"0";
        console.debug("");
        }
        }
        }
        }
        */
        row9.setValue(total);
        //alert(6);
    },

    onEst_Ret_SaveClick: function(button, e, options) {
        //var frmEstimatedReturn = Ext.ComponentQuery.query('#frm_EstimatedReturn')[0].getForm();
        var action = Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0].getValue();
        var form = button.up('form').getForm();

        /*
        if(action == "E")
        {
        msg("WARNING","Please Enter  PAN No. !!!");


        return;
        }



        if(!form.isValid())
        {
        msg("WARNING","कृपया छूटेका विवरण भर्नुहोस्!!!");   
        return;

        }
        else
        {

        }
        */
        this.SaveEstimatedReturn("I"); 


    },

    onEst_Ret_VoucherListAfterRender: function(abstractcomponent, options) {
        //var EstLoginOffcode = Ext.ComponentQuery.query('#Est_Ret_VoucherList')[0];
        Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].setValue('10');

        var offCode = Ext.get('offCode').dom.innerHTML;
        //alert(offCode);
        //Ext.getStore('Est_Ret_VoucherList').loadData([],false);
        Ext.ComponentQuery.query('#EstLoginOffcode')[0].setValue(offCode);
        //Ext.getStore('RevenueAccountStore')loadData();

        Ext.Ajax.request({
            url: '../HANDLERS/Common/OfficeBankInfoHandler.ashx?method=GetOfficeBankInfo',
            params:{officeCode:offCode},
            success: function ( result, request ) {

                var data = Ext.decode(result.responseText); 
                // combo.store.loadData(data.root);        
                Ext.getStore('OfficeBankInfo').loadData(data.root);

            },
            failure: function ( result, request ) {
                Ext.Msg.show({
                    title: 'Failure',
                    msg: 'ERROR OCURRED !!!' ,
                    buttons: Ext.MessageBox.OK,
                    icon:Ext.Msg.ERROR
                });
            }

        });




        var grd = Ext.ComponentQuery.query('#Est_Ret_VoucherList')[0];

        grd.getStore().loadData([],false);

        grd.on('beforeedit', function(editor,e) {
            var valid=true;

        });


        grd.on('validateedit', function(editor, e) {



        });

        grd.getPlugin('Est_Ret_RowEdtPlgn').on('canceledit',function(e){    



        });

    },

    onEst_Ret_EditClick: function(button, e, options) {
        //Ext.ComponentQuery.query('#txtEst_Ret_SUBMISSION_NO')[0].disabled=false;
        var txtEst_Ret_Submission_No = Ext.ComponentQuery.query('#txtEst_Ret_SUBMISSION_NO')[0];
        txtEst_Ret_Submission_No.setDisabled(false);
        var hdnEstAction = Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0];
        var hdnlblEstimateReturnAction = Ext.ComponentQuery.query('#hdnlblEstimateReturnAction')[0];
        //this.ClearEstimatedReturn();
        txtEst_Ret_Submission_No.focus();
        hdnEstAction.setValue("E");
        hdnlblEstimateReturnAction.setValue(" Updating  ... कृपया सबमिसन न. भर्नुहोस ");

    },

    onEst_Ret_DeleteClick: function(button, e, options) {
        var me = this;

        var txtEst_Ret_Submission_No = Ext.ComponentQuery.query('#txtEst_Ret_SUBMISSION_NO')[0];
        txtEst_Ret_Submission_No.setDisabled(false);
        txtEst_Ret_Submission_No.focus();

        var hdnEstAction = Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0];
        var hdnlblEstimateReturnAction = Ext.ComponentQuery.query('#hdnlblEstimateReturnAction')[0];
        hdnEstAction.setValue("D");
        hdnlblEstimateReturnAction.setValue("Deleting ... कृपया सबमिसन न. भर्नुहोस् ");
        //this.ClearEstimatedReturn();





    },

    onEst_Ret_CancelClick: function(button, e, options) {
        this.ClearEstimatedReturn();
    },

    onEst_Ret_submitClick: function(button, e, options) {

        var me = this;
        var loadMsg = "";
        var count = 0;
        var errorMsg = "";


        //var frmEstimatedReturn = Ext.ComponentQuery.query('#frm_EstimatedReturn')[0].getForm();
        var form = button.up('form').getForm();
        var action = Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0].getValue();


        var dispEst_Ret_submissionNo = Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].getValue();



        var txtEst_Ret_PanNo =  Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].getValue();
        var txtEst_Ret_AccType = Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].getValue();
        var ddlEst_Ret_ReturnType = Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0].getValue();
        var ddlEstFysicalYear = Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].getValue();

        //alert(ddlEstFysicalYear);
        if(ddlEst_Ret_ReturnType === null )
        {

            count++;
            errorMsg = errorMsg + '<br/>'+ count + ") कृपया अनुमानित करको प्रकार छान्नुहोस् !!!";

        }
        /*
        if(hdnEst_Ret_Office_Code === "")
        {

        count++;
        errorMsg = errorMsg + '<br/>'+ count + ") कृपया कार्यालय कोड भर्नुहोस्!!!";

        }
        */

        //alert(txtEst_Ret_PanNo);
        if(txtEst_Ret_PanNo === "")
        {

            count++;
            errorMsg = errorMsg + '<br/>'+ count + ") कृपया स्था . ले . नं . भर्नुहोस् !!!";

        }

        if(txtEst_Ret_AccType === "")
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ")कृपया खाताको किसिम  भर्नुहोस् !!!";

        }

        if(ddlEstFysicalYear === null )
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ")कृपया आय बर्ष छान्नुहोस् !!! ";

        }

        if(count >0)
        {
            msg("WARNING",errorMsg);
            return false;
        }

















        /*
        if(dispEst_Ret_submissionNo == "" )
        {
        msg("WARNING","कृपया छूटेका सबमिसन न. भर्नुहोस्!!!");

        return;
        }

        if(!form.isValid())
        {
        msg("WARNING","कृपया छूटेका विवरण भर्नुहोस्!!!");   
        return;

        }
        */
        if(action === "D")
        {

            //------------------------------------------------------
            // NB: Posting Data to Server
            //------------------------------------------------------

            Ext.Ajax.request({
                url:"../Handlers/IncomeTax/EstimatesReturn/EstimateReturnsHandlers1.ashx?method=DeleteEstimateReturn" ,
                params:{submissionNumber:Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].getValue()
                },
                success: function ( result, request ) {

                    var obj = Ext.decode(result.responseText);

                    msg(obj.success === "true" ?"SUCCESS":"FAILURE",obj.message);

                    if(obj.success === "false") return;


                    me.ClearEstimatedReturn();



                },
                failure: function ( result, request ) {

                    var obj = Ext.decode(result.responseText);

                    msg("FAILURE",obj.message);
                    return;
                }

            });


        }

        else
        {
            Ext.Msg.confirm('Confirm Action', 'एकपटक Submit गरिसकेपछि अर्को पटक विवरण फेरि परिवर्तन गर्न पइने छैन। \n के तपाई Submit गर्न चाहनुहन्छ ?', function(btn) {
                if(btn == 'yes'){


                    me.SaveEstimatedReturn("F");

                    return true;
                }
            }, this);


        }

    },

    onTxtEst_Ret_SUBMISSION_NOKeypress: function(textfield, e, options) {
        var me=this;
        var uiConfig='';

        var menuLink;
        var pageTitle;
        Ext.getStore('Est_Ret_VoucherList').loadData([],false);

        if(e.keyCode === 13 || e.keyCode === 9)
        {
            Ext.getStore('Est_Ret_VoucherList').loadData([],false);
            // Ext.ComponentQuery.query('#txtEst_Ret_FiscalYear')[0].setDisabled(false);
            // Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].setDisabled(false);

            var submissionNo = Ext.ComponentQuery.query('#txtEst_Ret_SUBMISSION_NO')[0].getValue();

            Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].setValue(submissionNo);


            Ext.Ajax.request({
                url: '../Handlers/IncomeTax/EstimatesReturn/EstimateReturnsHandlers1.ashx',
                params: {
                    method:'GetEstimateReturn',submissionNumber:submissionNo,
                    id: 1
                },
                success: function(response){
                    var obj =Ext.decode( response.responseText);
                    //console.log(obj);
                    var estReturn=obj.root;
                    var taxpayer=estReturn.Taxpayer;
                    var office=taxpayer.Office;
                    var address=taxpayer.BusinessAddress.Address;

                    // console.log(estReturn);



                    Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].setValue(obj.root.PAN);
                    Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].setValue(taxpayer.acctType);
                    //SET TAXPAYER'S INFO
                    Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0].setValue(office.OfficeCode);
                    Ext.ComponentQuery.query('#Est_Ret_IROName')[0].setValue(office.OfficeNameNepali);
                    Ext.ComponentQuery.query('#txtEst_Ret_Name')[0].setValue(taxpayer.Name);


                    Ext.ComponentQuery.query('#txtEst_Ret_HouseNo')[0].setValue(address.HouseNo);
                    Ext.ComponentQuery.query('#txtEst_Ret_WardNo')[0].setValue(address.WardNo);
                    Ext.ComponentQuery.query('#txtEst_Ret_ToleName')[0].setValue(address.StreetName);

                    if(address.LocationType=='MM')
                    {
                        Ext.ComponentQuery.query('#rdl_Est_Metro_Mun')[0].setValue(true);
                        Ext.ComponentQuery.query('#rdl_Est_Metro_Mun')[0].setReadOnly(true);
                    }
                    else if(address.LocationType === 'SM')
                    {
                        Ext.ComponentQuery.query('#rdl_Est_Sub_Metro_Mun')[0].setValue(true);
                        Ext.ComponentQuery.query('#rdl_Est_Sub_Metro_Mun')[0].setReadOnly(true);
                    }
                    else if(address.LocationType === 'MN')
                    {
                        Ext.ComponentQuery.query('#rdl_Est_Mun')[0].setValue(true);
                        Ext.ComponentQuery.query('#rdl_Est_Mun')[0].setReadOnly(true);
                    }
                    else if(address.LocationType === 'VD')
                    {
                        Ext.ComponentQuery.query('#rdl_Est_VDC')[0].setValue(true);
                        Ext.ComponentQuery.query('#rdl_Est_VDC')[0].setReadOnly(true);
                    }

                    Ext.ComponentQuery.query('#txtEst_Ret_VDCName')[0].setValue(address.VdcTown);
                    Ext.ComponentQuery.query('#txtEst_Ret_DistrictName')[0].setValue(address.DistrictNameNep);
                    Ext.ComponentQuery.query('#txtEst_Ret_Phone')[0].setValue(address.Telephone);
                    //Ext.ComponentQuery.query('#txtEst_Ret_Mobile')[0].setValue(true);
                    Ext.ComponentQuery.query('#txtEst_Ret_Email')[0].setValue(address.Email);
                    if(taxpayer.AcctStatus==='A')
                    Ext.ComponentQuery.query('#Est_Ret_TpOfficeType')[0].setValue('सक्रिय');


                    //Load Estimate Return
                    Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].setValue(estReturn.AccType);
                    Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0].setValue(estReturn.EstimateType);
                    Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0].setReadOnly(true);

                    Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].setValue(estReturn.FiscalYear);
                    Ext.ComponentQuery.query('#txtEst_Ret_Income')[0].setValue(estReturn.EstIncome);
                    Ext.ComponentQuery.query('#txtEst_Ret_Deductions')[0].setValue(estReturn.EstDeductions);
                    Ext.ComponentQuery.query('#txtEst_Ret_Exempt_Amount')[0].setValue(estReturn.EstExemptAmount);
                    Ext.ComponentQuery.query('#txtEst_Ret_Assessable_Income')[0].setValue(estReturn.EstAssessableIncome);
                    Ext.ComponentQuery.query('#txtEst_Ret_Income_Oth_Bus_Inv')[0].setValue(estReturn.EstIncomeOthBusInv);
                    Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0].setValue(estReturn.EstTtotalAssessableIncome);
                    Ext.ComponentQuery.query('#txtEst_Ret_Donation_To_Exempt_Org')[0].setValue(estReturn.DonationToExemptOrg);
                    Ext.ComponentQuery.query('#txtEst_Ret_Retirement_Contribution')[0].setValue(estReturn.EstRetirementContribution);
                    Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0].setValue(estReturn.EstTaxableIncome);
                    Ext.ComponentQuery.query('#txtEst_Ret_Tax_Liability')[0].setValue(estReturn.EstTaxLiability);
                    Ext.ComponentQuery.query('#txtEst_Ret_TDS_Paid_Amt')[0].setValue(estReturn.EstTdsPaidAmt);
                    Ext.ComponentQuery.query('#txtEst_Ret_Inst_Paid_Amt')[0].setValue(estReturn.EstInstPaidAmt);

                    Ext.ComponentQuery.query('#txtEst_Ret_Foreign_Tax')[0].setValue(estReturn.EstForeignTax);
                    Ext.ComponentQuery.query('#txtEst_Ret_Income_Sent_Abroad')[0].setValue(estReturn.EstIncomeSentAbroad);
                    Ext.ComponentQuery.query('#txtEst_Ret_Tax_OnIncome_Sent_Abraod')[0].setValue(estReturn.EstTaxOnIncomeSentAbraod);

                    Ext.ComponentQuery.query('#hdnEstFilingDate')[0].setValue(estReturn.FilingDate);
                    // Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0].setValue(estReturn.Status);
                    // Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0].setValue('E');
                    // Ext.ComponentQuery.query('#hdnlblEstimateReturnAction')[0].setValue('Updating');
                    Ext.ComponentQuery.query('#hdnEstimateReturnTranNo')[0].setValue(estReturn.TranNo);

                    //console.log('EstimateRet',estReturn);
                    var grd = Ext.ComponentQuery.query('#Est_Ret_VoucherList')[0];
                    var store  = Ext.getStore('Est_Ret_VoucherList');
                    store.add(estReturn.VoucherTbs); 
                    grd.bindStore(store);
                    //console.log(store);
                    //estReturn.Status

                    //alert('msgg ' +    obj.message +   'estatus  ' + estReturn.Status );
                    if(obj.message === "F" || estReturn.Status === "F") 
                    {
                        var Est_Ret_Save = Ext.ComponentQuery.query("#Est_Ret_Save")[0];
                        var Est_Ret_submit = Ext.ComponentQuery.query("#Est_Ret_submit")[0];
                        var Est_Ret_Delete = Ext.ComponentQuery.query("#Est_Ret_Delete")[0];
                        Est_Ret_Delete.setDisabled(true);
                        Est_Ret_Save.setDisabled(true);
                        Est_Ret_submit.setDisabled(true);
                        msg("WARNING","Estimate Return is already Finalized !!!");

                        return;                
                    }

                },
                failure: function ( result, request ) {
                    Ext.Msg.show({
                        title: 'Failure',
                        msg: 'ERROR OCURRED !!!' ,
                        buttons: Ext.MessageBox.OK,
                        icon:Ext.Msg.ERROR
                    });
                }
            });                    

        }

    },

    onTxtEst_Ret_PanNoBlur: function(field, options) {
        this.PanCurrentOfficeTaxpayerInfo();
    },

    onDdlEst_Ret_ReturnTypeBlur: function(field, options) {
        var txtEst_Ret_PanNo =  Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].getValue();
        var txtEst_Ret_AccType = Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].getValue();
        var ddlEstFysicalYear = Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].getValue();

        var ddlEst_Ret_ReturnType = Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0].getValue();
        var ddlEstRetReturnType = "";

        //alert(ddlEst_Ret_ReturnType);
        if(ddlEst_Ret_ReturnType === 'IR' || ddlEst_Ret_ReturnType === 'RN' )
        {

            if(ddlEst_Ret_ReturnType === 'IR')
            {
                ddlEstRetReturnType = 'IN';
            }
            else
            {
                ddlEstRetReturnType = 'IR';
            }




            Ext.Ajax.request({
                url:"../Handlers/IncomeTax/EstimatesReturn/EstimateReturnsHandlers1.ashx?method=CheckForINEstimateReturn" ,
                params:{PAN:txtEst_Ret_PanNo,accType:txtEst_Ret_AccType,fiscalYear:ddlEstFysicalYear,estimateType:ddlEstRetReturnType
                },
                success: function ( result, request ) {

                    var obj = Ext.decode(result.responseText);

                    if(obj.message !== "OK")
                    {

                        msg(obj.success === "true" ?"WARNING":"FAILURE",obj.message,function(){field.focus();});
                        return;
                    }


                },
                failure: function ( result, request ) {

                    var obj = Ext.decode(result.responseText);

                    msg("FAILURE",obj.message);
                    return;
                }

            });
        }

    },

    SaveEstimatedReturn: function(Status) {
        var me = this;
        var loadMsg = "";
        var count = 0;
        var errorMsg = "";

        var txtEst_Ret_SUBMISSION_NO = Ext.ComponentQuery.query('#txtEst_Ret_SUBMISSION_NO')[0].getValue(); // used at the time of manual  Editing

        var hdnEst_Ret_Office_Code = Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0].getValue();

        var txtEst_Ret_PanNo =  Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].getValue();
        var txtEst_Ret_AccType = Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].getValue();
        var ddlEst_Ret_ReturnType = Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0].getValue();


        var ddlEstFysicalYear = Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].getValue();

        //alert(ddlEstFysicalYear);
        if(ddlEst_Ret_ReturnType === null )
        {

            count++;
            errorMsg = errorMsg + '<br/>'+ count + ") कृपया अनुमानित करकोक़  प्रकार छान्नुहोस् !!!";

        }
        /*
        if(hdnEst_Ret_Office_Code === "")
        {

        count++;
        errorMsg = errorMsg + '<br/>'+ count + ") कृपया कार्यालय कोड भर्नुहोस् !!!";

        }
        */

        //alert(txtEst_Ret_PanNo);
        if(txtEst_Ret_PanNo === "")
        {

            count++;
            errorMsg = errorMsg + '<br/>'+ count + ") कृपया स्था . ले . नं . भर्नुहोस् !!!";

        }

        if(txtEst_Ret_AccType === "")
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ") कृपया खाताको किसिम  भर्नुहोस् !!!";

        }

        if(ddlEstFysicalYear === null )
        {

            count++;
            errorMsg = errorMsg +'<br/>'+ count + ") कृपया आय बर्ष छान्नुहोस् !!! ";

        }

        if(count >0)
        {
            msg("WARNING",errorMsg);
            return false;
        }











        //for second part
        var txtEst_Ret_Income = Ext.ComponentQuery.query('#txtEst_Ret_Income')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Income')[0].getValue();
        var txtEst_Ret_Deductions = Ext.ComponentQuery.query('#txtEst_Ret_Deductions')[0].getValue() === "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Deductions')[0].getValue();
        var txtEst_Ret_Exempt_Amount = Ext.ComponentQuery.query('#txtEst_Ret_Exempt_Amount')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Exempt_Amount')[0].getValue();
        var txtEst_Ret_Assessable_Income = Ext.ComponentQuery.query('#txtEst_Ret_Assessable_Income')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Assessable_Income')[0].getValue();
        var txtEst_Ret_Income_Oth_Bus_Inv = Ext.ComponentQuery.query('#txtEst_Ret_Income_Oth_Bus_Inv')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Income_Oth_Bus_Inv')[0].getValue();
        var txtEst_Ret_Total_Assessable_Income = Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0].getValue();
        var txtEst_Ret_Donation_To_Exempt_Org = Ext.ComponentQuery.query('#txtEst_Ret_Donation_To_Exempt_Org')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Donation_To_Exempt_Org')[0].getValue();
        var txtEst_Ret_Retirement_Contribution = Ext.ComponentQuery.query('#txtEst_Ret_Retirement_Contribution')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Retirement_Contribution')[0].getValue();
        var txtEst_Ret_Taxable_Income = Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0].getValue();
        var txtEst_Ret_Tax_Liability = Ext.ComponentQuery.query('#txtEst_Ret_Tax_Liability')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Tax_Liability')[0].getValue();
        var txtEst_Ret_TDS_Paid_Amt = Ext.ComponentQuery.query('#txtEst_Ret_TDS_Paid_Amt')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_TDS_Paid_Amt')[0].getValue();
        var txtEst_Ret_Inst_Paid_Amt = Ext.ComponentQuery.query('#txtEst_Ret_Inst_Paid_Amt')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Inst_Paid_Amt')[0].getValue();

        // for 3rd part
        var txtEst_Ret_Foreign_Tax = Ext.ComponentQuery.query('#txtEst_Ret_Foreign_Tax')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Foreign_Tax')[0].getValue();
        var txtEst_Ret_Income_Sent_Abroad = Ext.ComponentQuery.query('#txtEst_Ret_Income_Sent_Abroad')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Income_Sent_Abroad')[0].getValue();
        var txtEst_Ret_Tax_OnIncome_Sent_Abraod = Ext.ComponentQuery.query('#txtEst_Ret_Tax_OnIncome_Sent_Abraod')[0].getValue()=== "" ?null:Ext.ComponentQuery.query('#txtEst_Ret_Tax_OnIncome_Sent_Abraod')[0].getValue();

        //for filing date
        //var hdnEstFilingDate =  Ext.ComponentQuery.query('#hdnEstFilingDate')[0].getValue();

        var action = Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0].getValue();

        var hdnEstimateReturnTranNo = Ext.ComponentQuery.query('#hdnEstimateReturnTranNo')[0].getValue();


        if(action == "E")
        {
            loadMsg = "Updating ...";
        }
        else
        {
            loadMsg = "Saving ...";
        }




        var strEst_Ret_VoucherList = Ext.getStore('Est_Ret_VoucherList');


        strEst_Ret_VoucherList.clearFilter();

        var voucherTbs = "";
        var estimateReturn = "";


        if(strEst_Ret_VoucherList.getCount() > 0)
        {
            voucherTbs = getJson(strEst_Ret_VoucherList); 

            strEst_Ret_VoucherList.filter(function(item){
                return item.get("Action")!= 'D';
            });
        }


        var SubmissionNo={
            SubmissionNumber:'',
            Username:'',
            Password:'',
            ContactNo:'',
            Emailid:'',
            submittedFor:'',
            SubmittedYN:'N',
            SubmittedDate:'',
            TranNo:'0',
            Address:'',
            RegOffice:'',
            Action:'A',
            PAN:txtEst_Ret_PanNo,
            FiscalYear:ddlEstFysicalYear
        };


        estimateReturn = { 
            SubmissionNumber:Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].getValue()!==null?Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].getValue():0,
            OfficeCode:Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0].getValue(),
            PAN:txtEst_Ret_PanNo,     
            AccType:txtEst_Ret_AccType, 
            EstimateType:ddlEst_Ret_ReturnType, 
            FiscalYear:ddlEstFysicalYear,
            ReturnRegNo:txtEst_Ret_SUBMISSION_NO,  
            FilingDate:"",
            EstIncome:txtEst_Ret_Income !== ""?txtEst_Ret_Income:null, 
            EstDeductions:txtEst_Ret_Deductions !== ""?txtEst_Ret_Deductions:null, 
            EstExemptAmount:txtEst_Ret_Exempt_Amount !== ""?txtEst_Ret_Exempt_Amount:null,
            EstAssessableIncome:txtEst_Ret_Assessable_Income !== ""?txtEst_Ret_Assessable_Income:null,
            EstIncomeOthBusInv:txtEst_Ret_Income_Oth_Bus_Inv !== ""?txtEst_Ret_Income_Oth_Bus_Inv:null,
            EstTtotalAssessableIncome:txtEst_Ret_Total_Assessable_Income !== ""?txtEst_Ret_Total_Assessable_Income:null,
            DonationToExemptOrg:txtEst_Ret_Donation_To_Exempt_Org !== ""?txtEst_Ret_Donation_To_Exempt_Org:null,
            EstRetirementContribution:txtEst_Ret_Retirement_Contribution !== ""?txtEst_Ret_Retirement_Contribution:null,
            EstTaxableIncome:txtEst_Ret_Taxable_Income !== ""?txtEst_Ret_Taxable_Income:null,
            EstTaxLiability:txtEst_Ret_Tax_Liability !== ""?txtEst_Ret_Tax_Liability:null,
            EstTdsPaidAmt:txtEst_Ret_TDS_Paid_Amt !== ""?txtEst_Ret_TDS_Paid_Amt:null,   
            EstInstPaidAmt:txtEst_Ret_Inst_Paid_Amt !== ""?txtEst_Ret_Inst_Paid_Amt:null,
            EstForeignTax:txtEst_Ret_Foreign_Tax !== ""?txtEst_Ret_Foreign_Tax:null,
            EstIncomeSentAbroad:txtEst_Ret_Income_Sent_Abroad!== ""?txtEst_Ret_Income_Sent_Abroad:null,
            EstTaxOnIncomeSentAbraod:txtEst_Ret_Tax_OnIncome_Sent_Abraod!== ""?txtEst_Ret_Tax_OnIncome_Sent_Abraod:null,
            Status:Status,
            Trandate:"",
            TranNo:hdnEstimateReturnTranNo !== ""?hdnEstimateReturnTranNo:null,
            Action:action,
            VoucherTbs:voucherTbs !== ""?voucherTbs:null,
            SubmissionNo:SubmissionNo


        };

        var waitSave = watiMsg(loadMsg);

        //console.log("status estimate",Status);

        console.log(estimateReturn);
        console.log(estimateReturn.SubmissionNo);
        //------------------------------------------------------
        // NB: Posting Data to Server
        //------------------------------------------------------

        Ext.Ajax.request({
            url:"../Handlers/IncomeTax/EstimatesReturn/EstimateReturnsHandlers1.ashx?method=SaveEstimateReturn",
            params:{estimateReturns:JSON.stringify(estimateReturn)},
            success: function ( result, request ) {

                waitSave.hide();

                var obj = Ext.decode(result.responseText);

                if(obj.success == "false" && obj.message === "ErrorDuplicate data !")
                {
                    msg("WARNING","Submission No is Already Exists !!!");
                    return;
                }

                msg(obj.success === "true" ?"SUCCESS":"FAILURE",obj.message);
                me.ClearEstimatedReturn();
                if(obj.success === "false") return;



            },
            failure: function ( result, request ) {

                waitSave.hide();

                var errMsg = "Error in " + loadMsg;

                msg("FAILURE",errMsg);
                return;
            }

        });


    },

    ClearEstimatedReturn: function() {

        var txtEst_Ret_Submission_No = Ext.ComponentQuery.query('#txtEst_Ret_SUBMISSION_NO')[0];

        var hdnEst_Ret_Office_Code = Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0];
        var txtEst_Ret_PanNo =  Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0];
        var txtEst_Ret_AccType = Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0];
        var ddlEst_Ret_ReturnType = Ext.ComponentQuery.query('#ddlEst_Ret_ReturnType')[0];

        var txtEst_Ret_Income = Ext.ComponentQuery.query('#txtEst_Ret_Income')[0];
        var txtEst_Ret_Deductions = Ext.ComponentQuery.query('#txtEst_Ret_Deductions')[0];
        var txtEst_Ret_Exempt_Amount = Ext.ComponentQuery.query('#txtEst_Ret_Exempt_Amount')[0];
        var txtEst_Ret_Assessable_Income = Ext.ComponentQuery.query('#txtEst_Ret_Assessable_Income')[0];
        var txtEst_Ret_Income_Oth_Bus_Inv = Ext.ComponentQuery.query('#txtEst_Ret_Income_Oth_Bus_Inv')[0];
        var txtEst_Ret_Total_Assessable_Income = Ext.ComponentQuery.query('#txtEst_Ret_Total_Assessable_Income')[0];
        var txtEst_Ret_Donation_To_Exempt_Org = Ext.ComponentQuery.query('#txtEst_Ret_Donation_To_Exempt_Org')[0];
        var txtEst_Ret_Retirement_Contribution = Ext.ComponentQuery.query('#txtEst_Ret_Retirement_Contribution')[0];
        var txtEst_Ret_Taxable_Income = Ext.ComponentQuery.query('#txtEst_Ret_Taxable_Income')[0];
        var txtEst_Ret_Tax_Liability = Ext.ComponentQuery.query('#txtEst_Ret_Tax_Liability')[0];
        var txtEst_Ret_TDS_Paid_Amt = Ext.ComponentQuery.query('#txtEst_Ret_TDS_Paid_Amt')[0];
        var txtEst_Ret_Inst_Paid_Amt = Ext.ComponentQuery.query('#txtEst_Ret_Inst_Paid_Amt')[0];
        var txtEst_Ret_Foreign_Tax = Ext.ComponentQuery.query('#txtEst_Ret_Foreign_Tax')[0];
        var txtEst_Ret_Income_Sent_Abroad = Ext.ComponentQuery.query('#txtEst_Ret_Income_Sent_Abroad')[0];
        var txtEst_Ret_Tax_OnIncome_Sent_Abraod = Ext.ComponentQuery.query('#txtEst_Ret_Tax_OnIncome_Sent_Abraod')[0];
        var hdnEstFilingDate =  Ext.ComponentQuery.query('#hdnEstFilingDate')[0];

        var action = Ext.ComponentQuery.query('#hdnEst_Ret_Action')[0];
        var hdnlblEstimateReturnAction = Ext.ComponentQuery.query('#hdnlblEstimateReturnAction')[0];
        var hdnEstimateReturnTranNo = Ext.ComponentQuery.query('#hdnEstimateReturnTranNo')[0];


        Ext.ComponentQuery.query('#ddlEstFysicalYear')[0].setValue("");

        // Taxpayer info clear

        Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].setValue("");
        Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0].setValue("");
        Ext.ComponentQuery.query('#Est_Ret_IROName')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_Name')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_HouseNo')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_WardNo')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_ToleName')[0].setValue("");
        Ext.ComponentQuery.query('#rdl_Est_Metro_Mun')[0].setValue(false);
        Ext.ComponentQuery.query('#rdl_Est_Sub_Metro_Mun')[0].setValue(false);
        Ext.ComponentQuery.query('#rdl_Est_Mun')[0].setValue(false);
        Ext.ComponentQuery.query('#rdl_Est_VDC')[0].setValue(false);
        Ext.ComponentQuery.query('#txtEst_Ret_VDCName')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_DistrictName')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_Phone')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_Mobile')[0].setValue("");
        Ext.ComponentQuery.query('#txtEst_Ret_Email')[0].setValue("");
        Ext.ComponentQuery.query('#Est_Ret_TpOfficeType')[0].setValue("");

        //txtEst_Ret_Submission_No.setValue("");


        //Estimate return Clear
        hdnEst_Ret_Office_Code.setValue("");
        txtEst_Ret_PanNo.setValue("");
        txtEst_Ret_PanNo.clearInvalid();
        txtEst_Ret_AccType.setValue("10");
        txtEst_Ret_AccType.clearInvalid();
        ddlEst_Ret_ReturnType.setValue("");
        txtEst_Ret_Income.setValue("");
        txtEst_Ret_Deductions.setValue("");
        txtEst_Ret_Exempt_Amount.setValue("");
        txtEst_Ret_Assessable_Income.setValue("");
        txtEst_Ret_Income_Oth_Bus_Inv.setValue("");
        txtEst_Ret_Total_Assessable_Income.setValue("");
        txtEst_Ret_Donation_To_Exempt_Org.setValue("");
        txtEst_Ret_Retirement_Contribution.setValue("");
        txtEst_Ret_Taxable_Income.setValue("");
        txtEst_Ret_Tax_Liability.setValue("");
        txtEst_Ret_TDS_Paid_Amt.setValue("");
        txtEst_Ret_Inst_Paid_Amt.setValue("");
        txtEst_Ret_Foreign_Tax.setValue("");
        txtEst_Ret_Income_Sent_Abroad.setValue("");
        txtEst_Ret_Tax_OnIncome_Sent_Abraod.setValue("");
        hdnEstFilingDate.setValue("");
        hdnEstimateReturnTranNo.setValue("");
        action.setValue(""); 
        hdnlblEstimateReturnAction.setValue("");
        Ext.getStore('Est_Ret_VoucherList').loadData([],false);


    },

    PanCurrentOfficeTaxpayerInfo: function() {
        var pan = Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].getValue();
        var offCode = Ext.ComponentQuery.query('#EstLoginOffcode')[0].getValue();
        var accType =  Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].getValue();
        var ddlEstFysicalYear =  Ext.ComponentQuery.query('#ddlEstFysicalYear')[0];

        LoadTaxpayerInfoWithValidPan(pan,accType,function(data){
            var taxpayer=data.root.Taxpayer;
            var address=taxpayer.BusinessAddress.Address;
            var office=taxpayer.Office;
            if(taxpayer.AcctStatus === "D")
            {
                msg("WARNING","PAN is Deactivated !!!");
                return;
            }
            if(offCode != office.OfficeCode)
            {
                msg("WARNING","PAN is not Registered in this office !!!");

                return;
            }

            //setReadOnly(true)
            // Ext.ComponentQuery.query('#dispEst_Ret_submissionNo')[0].setValue(submissionNo);

            // Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].setValue(pan);
            //Ext.ComponentQuery.query('#txtEst_Ret_PanNo')[0].setReadOnly(true);

            //Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].setValue('10');
            //Ext.ComponentQuery.query('#txtEst_Ret_AccType')[0].setReadOnly(true);

            Ext.ComponentQuery.query('#hdnEst_Ret_Office_Code')[0].setValue(office.OfficeCode);
            Ext.ComponentQuery.query('#Est_Ret_IROName')[0].setValue(office.OfficeNameNepali);
            Ext.ComponentQuery.query('#Est_Ret_IROName')[0].setReadOnly(true);

            Ext.ComponentQuery.query('#txtEst_Ret_Name')[0].setValue(taxpayer.Name);
            Ext.ComponentQuery.query('#txtEst_Ret_Name')[0].setReadOnly(true);



            Ext.ComponentQuery.query('#txtEst_Ret_HouseNo')[0].setValue(address.HouseNo);
            Ext.ComponentQuery.query('#txtEst_Ret_HouseNo')[0].setReadOnly(true);
            Ext.ComponentQuery.query('#txtEst_Ret_WardNo')[0].setValue(address.WardNo);
            Ext.ComponentQuery.query('#txtEst_Ret_WardNo')[0].setReadOnly(true);
            Ext.ComponentQuery.query('#txtEst_Ret_ToleName')[0].setValue(address.StreetName);
            Ext.ComponentQuery.query('#txtEst_Ret_ToleName')[0].setReadOnly(true);

            if(address.LocationType === 'MM')
            {
                Ext.ComponentQuery.query('#rdl_Est_Metro_Mun')[0].setValue(true);
                Ext.ComponentQuery.query('#rdl_Est_Metro_Mun')[0].setReadOnly(true);
            }
            else if(address.LocationType === 'SM')
            {
                Ext.ComponentQuery.query('#rdl_Est_Sub_Metro_Mun')[0].setValue(true);
                Ext.ComponentQuery.query('#rdl_Est_Sub_Metro_Mun')[0].setReadOnly(true);
            }
            else if(address.LocationType === 'MN')
            {
                Ext.ComponentQuery.query('#rdl_Est_Mun')[0].setValue(true);
                Ext.ComponentQuery.query('#rdl_Est_Mun')[0].setReadOnly(true);
            }
            else if(address.LocationType === 'VD')
            {
                Ext.ComponentQuery.query('#rdl_Est_VDC')[0].setValue(true);
                Ext.ComponentQuery.query('#rdl_Est_VDC')[0].setReadOnly(true);
            }

            Ext.ComponentQuery.query('#txtEst_Ret_VDCName')[0].setValue(address.VdcTown);
            Ext.ComponentQuery.query('#txtEst_Ret_VDCName')[0].setReadOnly(true);
            Ext.ComponentQuery.query('#txtEst_Ret_DistrictName')[0].setValue(address.DistrictNameNep);
            Ext.ComponentQuery.query('#txtEst_Ret_DistrictName')[0].setReadOnly(true);
            // Ext.ComponentQuery.query('#txtEst_Ret_Phone')[0].setValue(address.Phone); address.Telephone
            Ext.ComponentQuery.query('#txtEst_Ret_Phone')[0].setValue(address.Telephone);
            Ext.ComponentQuery.query('#txtEst_Ret_Phone')[0].setReadOnly(true);


            //Ext.ComponentQuery.query('#txtEst_Ret_Mobile')[0].setValue(true);
            Ext.ComponentQuery.query('#txtEst_Ret_Email')[0].setValue(address.Email);
            Ext.ComponentQuery.query('#txtEst_Ret_Email')[0].setReadOnly(true);

            if(taxpayer.AcctStatus === 'A')
            Ext.ComponentQuery.query('#Est_Ret_TpOfficeType')[0].setValue('सक्रिय');
            Ext.Ajax.request({
                url: '../HANDLERS/Common/OfficeBankInfoHandler.ashx?method=GetOfficeBankInfo',
                params:{officeCode:office.OfficeCode},
                success: function ( result, request ) {

                    var data = Ext.decode(result.responseText); 
                    // combo.store.loadData(data.root);        
                    Ext.getStore('OfficeBankInfo').loadData(data.root);

                },
                failure: function ( result, request ) {
                    Ext.Msg.show({
                        title: 'Failure',
                        msg: 'ERROR OCURRED !!!' ,
                        buttons: Ext.MessageBox.OK,
                        icon:Ext.Msg.ERROR
                    });
                }

            });

        });

    },

    calProfitLoss: function() {
        var row1=Ext.ComponentQuery.query('#txtEst_Ret_Income')[0]; 
        var row2=Ext.ComponentQuery.query('#txtEst_Ret_Deductions')[0]; 
        var row3=Ext.ComponentQuery.query('#txtEst_Ret_Exempt_Amount')[0]; 
        var row4=Ext.ComponentQuery.query('#txtEst_Ret_Assessable_Income')[0]; 
        var total= 0.00;

        var val1 = getFloat(row1.getValue()); 
        var val2 = getFloat(row2.getValue());  
        var val3 = getFloat(row3.getValue()); 

        //total = (Number(val1) - (Number(val2) + Number(val3)));

        total = val1 - (val2 + val3);


        var arr =  String.split(total,'.');

        if(arr.length>1)
        {
            total   =  arr[0]+"."+arr[1].substring(0,2);
            if(arr[1].length==1)
            {
                total=total+"0";
                console.debug("");
            }
        }


        row4.setValue(total);
    },

    init: function(application) {
        this.control({
            "#frm_EstimatedReturn": {
                afterrender: this.onFrm_EstimatedReturnAfterRender
            },
            "#Est_Ret_AddVoucher": {
                click: this.onEst_Ret_AddVoucherClick
            },
            "#Est_Ret_VoucherList": {
                beforerender: this.onEst_Ret_VoucherListBeforeRender,
                afterrender: this.onEst_Ret_VoucherListAfterRender
            },
            "#txtEst_Ret_PanNo": {
                keypress: this.onTxtEst_Ret_PanNoKeypress,
                blur: this.onTxtEst_Ret_PanNoBlur
            },
            "#txtEst_Ret_Income": {
                blur: this.onTxtEst_Ret_IncomeBlur
            },
            "#txtEst_Ret_Deductions": {
                blur: this.onTxtEst_Ret_DeductionsBlur
            },
            "#txtEst_Ret_Exempt_Amount": {
                blur: this.onTxtEst_Ret_Exempt_AmountBlur
            },
            "#txtEst_Ret_Income_Oth_Bus_Inv": {
                blur: this.onTxtEst_Ret_Income_Oth_Bus_InvBlur
            },
            "#txtEst_Ret_Donation_To_Exempt_Org": {
                blur: this.onTxtEst_Ret_Donation_To_Exempt_OrgBlur
            },
            "#txtEst_Ret_Retirement_Contribution": {
                blur: this.onTxtEst_Ret_Retirement_ContributionBlur
            },
            "#txtEst_Ret_Assessable_Income": {
                change: this.onTxtEst_Ret_Assessable_IncomeChange
            },
            "#txtEst_Ret_Total_Assessable_Income": {
                change: this.onTxtEst_Ret_Total_Assessable_IncomeChange
            },
            "#Est_Ret_Save": {
                click: this.onEst_Ret_SaveClick
            },
            "#Est_Ret_Edit": {
                click: this.onEst_Ret_EditClick
            },
            "#Est_Ret_Delete": {
                click: this.onEst_Ret_DeleteClick
            },
            "#Est_Ret_Cancel": {
                click: this.onEst_Ret_CancelClick
            },
            "#Est_Ret_submit": {
                click: this.onEst_Ret_submitClick
            },
            "#txtEst_Ret_SUBMISSION_NO": {
                keypress: this.onTxtEst_Ret_SUBMISSION_NOKeypress
            },
            "#ddlEst_Ret_ReturnType": {
                blur: this.onDdlEst_Ret_ReturnTypeBlur
            }
        });
    }

});
